<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVtailro Admin</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%236C5CE7' width='100' height='100' rx='20'/><text x='50' y='68' font-size='60' font-weight='bold' text-anchor='middle' fill='white' font-family='system-ui'>CV</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f0f2f5;
            --card: #ffffff;
            --border: #e2e8f0;
            --text: #1a1a2e;
            --text-secondary: #64748b;
            --accent: #6C5CE7;
            --accent-hover: #5A4BD1;
            --accent-light: rgba(108,92,231,0.08);
            --accent-light-border: rgba(108,92,231,0.2);
            --success: #00B894;
            --error: #E17055;
            --warning: #FDCB6E;
            --sidebar-bg: #0f172a;
            --sidebar-text: #94a3b8;
            --sidebar-active: rgba(108,92,231,0.15);
            --sidebar-width: 240px;
            --header-height: 56px;
            --radius: 16px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        /* ─── Auth Layout (no sidebar) ─── */
        .auth-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            padding: 24px;
        }
        .auth-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.06);
        }
        .auth-card .auth-logo {
            text-align: center;
            margin-bottom: 28px;
        }
        .auth-card .auth-logo h1 {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, var(--accent), #a29bfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .auth-card .auth-logo p {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 4px;
        }
        .auth-card h2 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text);
        }

        /* ─── Dashboard Layout ─── */
        .app-layout {
            display: none;
            min-height: 100vh;
        }

        /* Header */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: var(--sidebar-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 100;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .top-header .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .top-header .header-logo {
            font-size: 18px;
            font-weight: 800;
            color: #fff;
            letter-spacing: -0.5px;
        }
        .top-header .header-badge {
            background: var(--accent);
            color: #fff;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .top-header .header-right a {
            color: var(--sidebar-text);
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            transition: color 0.2s;
        }
        .top-header .header-right a:hover {
            color: #fff;
        }
        .mobile-toggle {
            display: none;
            background: none;
            border: none;
            color: #fff;
            font-size: 22px;
            cursor: pointer;
            padding: 4px;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: var(--header-height);
            left: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            z-index: 90;
            overflow-y: auto;
            border-right: 1px solid rgba(255,255,255,0.06);
        }
        .sidebar-nav {
            flex: 1;
            padding: 16px 0;
        }
        .sidebar-nav .nav-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(148,163,184,0.5);
            padding: 16px 20px 8px;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 11px 20px;
            color: var(--sidebar-text);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s;
            border-left: 3px solid transparent;
            text-decoration: none;
        }
        .nav-item:hover {
            color: #e2e8f0;
            background: rgba(255,255,255,0.04);
        }
        .nav-item.active {
            color: #fff;
            background: var(--sidebar-active);
            border-left-color: var(--accent);
        }
        .nav-item .nav-icon {
            font-size: 16px;
            width: 24px;
            text-align: center;
            flex-shrink: 0;
        }
        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid rgba(255,255,255,0.06);
        }
        .sidebar-footer .nav-item {
            padding: 10px 16px;
            border-radius: 8px;
            border-left: none;
            color: #ef4444;
        }
        .sidebar-footer .nav-item:hover {
            background: rgba(239,68,68,0.1);
            color: #f87171;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: var(--header-height);
            padding: 28px 32px 60px;
            min-height: calc(100vh - var(--header-height));
        }

        /* Tab Content Sections */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Tab Header */
        .tab-header {
            margin-bottom: 24px;
        }
        .tab-header h1 {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: -0.5px;
            color: var(--text);
        }
        .tab-header p {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Cards */
        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.04);
            transition: box-shadow 0.2s, transform 0.2s;
        }
        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.06), 0 2px 4px rgba(0,0,0,0.03);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .card-header h2 {
            font-size: 15px;
            font-weight: 700;
            color: var(--text);
        }

        /* Metric Cards */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .metric-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 22px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.04);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: default;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        }
        .metric-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-bottom: 14px;
        }
        .metric-icon.purple { background: rgba(108,92,231,0.1); }
        .metric-icon.green { background: rgba(0,184,148,0.1); }
        .metric-icon.orange { background: rgba(225,112,85,0.1); }
        .metric-icon.blue { background: rgba(9,132,227,0.1); }
        .metric-icon.yellow { background: rgba(253,203,110,0.15); }
        .metric-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--text);
            letter-spacing: -0.5px;
            line-height: 1.1;
        }
        .metric-value.status-good { color: var(--success); }
        .metric-value.status-bad { color: var(--error); }
        .metric-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-top: 6px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        /* Forms */
        .form-group { margin-bottom: 18px; }
        .form-group label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            display: block;
            margin-bottom: 6px;
        }
        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-family: inherit;
            background: #fff;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(108,92,231,0.1);
        }
        .form-group .hint {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        .input-with-btn {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .input-with-btn input { flex: 1; }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 18px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
            cursor: pointer;
        }
        .checkbox-group label {
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 0;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: inherit;
        }
        .btn-primary {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 8px rgba(108,92,231,0.25);
        }
        .btn-primary:hover {
            background: var(--accent-hover);
            box-shadow: 0 4px 16px rgba(108,92,231,0.35);
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: #f1f5f9;
            color: var(--text);
            border: 1px solid var(--border);
        }
        .btn-secondary:hover { background: #e2e8f0; }
        .btn-danger {
            background: rgba(225,112,85,0.1);
            color: var(--error);
            border: 1px solid rgba(225,112,85,0.2);
        }
        .btn-danger:hover { background: rgba(225,112,85,0.18); }
        .btn-sm { padding: 7px 14px; font-size: 12px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-row { display: flex; gap: 10px; flex-wrap: wrap; }

        /* Alerts */
        .alert {
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            margin-bottom: 16px;
            display: none;
        }
        .alert.success { background: rgba(0,184,148,0.08); color: var(--success); border: 1px solid rgba(0,184,148,0.2); display: block; }
        .alert.error { background: rgba(225,112,85,0.08); color: var(--error); border: 1px solid rgba(225,112,85,0.2); display: block; }

        /* Analytics Table */
        .analytics-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .analytics-table th {
            text-align: left;
            padding: 10px 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border);
            background: var(--bg);
        }
        .analytics-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
        }
        .analytics-table tr:last-child td { border-bottom: none; }
        .analytics-table tr:hover td { background: rgba(108,92,231,0.03); }
        .analytics-table .num { text-align: right; font-variant-numeric: tabular-nums; }
        .analytics-bar {
            height: 6px;
            border-radius: 3px;
            background: var(--accent);
            display: inline-block;
            vertical-align: middle;
            margin-right: 6px;
            min-width: 2px;
        }

        /* Search Input */
        .search-input {
            width: 100%;
            padding: 10px 14px 10px 38px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-family: inherit;
            background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85zm-5.442.156a5 5 0 1 1 0-10 5 5 0 0 1 0 10z'/%3E%3C/svg%3E") 12px center no-repeat;
        }
        .search-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(108,92,231,0.1);
        }

        /* User Cards (for search data attributes) */
        .user-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
        }
        .user-card:hover {
            background: var(--accent-light);
            border-color: var(--accent-light-border);
        }

        /* System Stats */
        .sys-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }
        .sys-stat {
            text-align: center;
            padding: 24px 16px;
            background: var(--bg);
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        .sys-stat .sys-val {
            font-size: 32px;
            font-weight: 800;
            color: var(--accent);
            letter-spacing: -0.5px;
        }
        .sys-stat .sys-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: var(--text-secondary);
            margin-top: 6px;
            font-weight: 600;
        }

        /* Recent Activity */
        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        .activity-item:last-child { border-bottom: none; }
        .activity-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent-light);
            color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 0;
        }
        .activity-avatar img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Resume Viewer */
        .resume-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .resume-tab-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #fff;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }
        .resume-tab-btn.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        /* Live indicator */
        .live-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            margin-right: 6px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        .empty-state .empty-icon {
            font-size: 36px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: var(--header-height);
                left: 0;
                right: 0;
                bottom: auto;
                width: 100%;
                flex-direction: row;
                overflow-x: auto;
                overflow-y: hidden;
                padding: 0;
                border-right: none;
                border-bottom: 1px solid rgba(255,255,255,0.06);
                transform: translateY(-100%);
                transition: transform 0.25s ease;
            }
            .sidebar.mobile-open {
                transform: translateY(0);
            }
            .sidebar-nav {
                display: flex;
                flex-direction: row;
                padding: 0;
                width: 100%;
                overflow-x: auto;
            }
            .sidebar-nav .nav-label { display: none; }
            .nav-item {
                white-space: nowrap;
                padding: 12px 16px;
                border-left: none;
                border-bottom: 3px solid transparent;
                font-size: 13px;
            }
            .nav-item.active {
                border-left-color: transparent;
                border-bottom-color: var(--accent);
            }
            .nav-item .nav-text { display: none; }
            .nav-item .nav-icon { margin: 0; }
            .sidebar-footer { display: none; }
            .mobile-toggle { display: block; }

            .main-content {
                margin-left: 0;
                padding: 20px 16px 60px;
            }
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .sys-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .tab-header h1 { font-size: 20px; }
        }
        @media (max-width: 480px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            .sys-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>

    <!-- ═══════════════════════════════════════════ -->
    <!-- AUTH SECTION (centered, no sidebar)         -->
    <!-- ═══════════════════════════════════════════ -->
    <div id="authSection" class="auth-wrapper">
        <div>
            <div class="auth-card" id="setPasswordCard" style="display:none">
                <div class="auth-logo">
                    <h1>CVtailro</h1>
                    <p>Admin Dashboard</p>
                </div>
                <h2>Set Admin Password</h2>
                <p style="font-size:14px;color:var(--text-secondary);margin-bottom:18px;">
                    No admin password has been set yet. Create one to secure this panel.
                </p>
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" placeholder="Enter a strong password">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" placeholder="Re-enter password">
                </div>
                <button class="btn btn-primary" onclick="setPassword()" style="width:100%;justify-content:center;">Set Password &amp; Login</button>
                <div id="setPasswordAlert" class="alert" style="margin-top:12px"></div>
            </div>

            <div class="auth-card" id="loginCard" style="display:none">
                <div class="auth-logo">
                    <h1>CVtailro</h1>
                    <p>Admin Dashboard</p>
                </div>
                <h2>Admin Login</h2>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter admin password"
                           onkeydown="if(event.key==='Enter')login()">
                </div>
                <button class="btn btn-primary" onclick="login()" style="width:100%;justify-content:center;">Login</button>
                <div id="loginAlert" class="alert" style="margin-top:12px"></div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════ -->
    <!-- DASHBOARD LAYOUT (sidebar + content)        -->
    <!-- ═══════════════════════════════════════════ -->
    <div id="configSection" class="app-layout">

        <!-- Top Header Bar -->
        <div class="top-header">
            <div class="header-left">
                <button class="mobile-toggle" onclick="toggleMobileMenu()" id="mobileToggleBtn">&#9776;</button>
                <span class="header-logo">CVtailro</span>
                <span class="header-badge">Admin</span>
            </div>
            <div class="header-right">
                <a href="/">&larr; Back to App</a>
            </div>
        </div>

        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebarNav">
            <div class="sidebar-nav">
                <div class="nav-label">Main</div>
                <a class="nav-item active" data-tab="dashboard" onclick="switchTab('dashboard')">
                    <span class="nav-icon">&#128202;</span>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a class="nav-item" data-tab="config" onclick="switchTab('config')">
                    <span class="nav-icon">&#9881;</span>
                    <span class="nav-text">Configuration</span>
                </a>
                <a class="nav-item" data-tab="users" onclick="switchTab('users')">
                    <span class="nav-icon">&#128101;</span>
                    <span class="nav-text">Users &amp; Resumes</span>
                </a>
                <div class="nav-label">Monitoring</div>
                <a class="nav-item" data-tab="analytics" onclick="switchTab('analytics')">
                    <span class="nav-icon">&#128200;</span>
                    <span class="nav-text">Analytics</span>
                </a>
                <a class="nav-item" data-tab="errors" onclick="switchTab('errors')">
                    <span class="nav-icon">&#128308;</span>
                    <span class="nav-text">Errors</span>
                </a>
                <a class="nav-item" data-tab="system" onclick="switchTab('system')">
                    <span class="nav-icon">&#128187;</span>
                    <span class="nav-text">System</span>
                </a>
            </div>
            <div class="sidebar-footer">
                <a class="nav-item" onclick="logout()">
                    <span class="nav-icon">&#9211;</span>
                    <span class="nav-text">Logout</span>
                </a>
            </div>
        </nav>

        <!-- Main Content Area -->
        <div class="main-content">

            <!-- ═══ TAB: DASHBOARD ═══ -->
            <div class="tab-content active" id="tab-dashboard">
                <div class="tab-header">
                    <h1>Dashboard</h1>
                    <p>Overview of your CVtailro service</p>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-icon purple">&#128101;</div>
                        <div class="metric-value" id="dashUsers">--</div>
                        <div class="metric-label">Total Users</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon blue">&#128196;</div>
                        <div class="metric-value" id="dashJobs">--</div>
                        <div class="metric-label">Total Jobs</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon green">&#128273;</div>
                        <div class="metric-value" id="dashApiStatus">--</div>
                        <div class="metric-label">API Key</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon orange">&#9881;</div>
                        <div class="metric-value" id="dashPipelines">--</div>
                        <div class="metric-label">Active Pipelines</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon yellow">&#128176;</div>
                        <div class="metric-value" id="dashCost">--</div>
                        <div class="metric-label">Est. Cost (USD)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon blue">&#9889;</div>
                        <div class="metric-value" id="dashRequests">--</div>
                        <div class="metric-label">Requests / Hour</div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <div class="card-header">
                        <h2>Recent Signups</h2>
                    </div>
                    <div id="recentActivity">
                        <div class="empty-state">
                            <div class="empty-icon">&#128101;</div>
                            <div>Loading recent activity...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ═══ TAB: CONFIGURATION ═══ -->
            <div class="tab-content" id="tab-config">
                <div class="tab-header">
                    <h1>Configuration</h1>
                    <p>Manage API keys, models, and rate limiting</p>
                </div>

                <!-- API Key -->
                <div class="card">
                    <div class="card-header">
                        <h2>API Key</h2>
                    </div>
                    <div class="form-group">
                        <label for="apiKeyInput">OpenRouter API Key</label>
                        <div class="input-with-btn">
                            <input type="password" id="apiKeyInput" placeholder="sk-or-v1-..."
                                   style="font-family: 'Inter', monospace;">
                            <button class="btn btn-sm btn-secondary" onclick="toggleApiKeyVisibility()" id="eyeBtn">Show</button>
                        </div>
                        <div class="hint">
                            Get your key at <a href="https://openrouter.ai/keys" target="_blank" rel="noopener noreferrer"
                            style="color:var(--accent);text-decoration:none;font-weight:600;">openrouter.ai/keys</a>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:12px;">
                        <button class="btn btn-sm btn-secondary" onclick="testApiKey()">Test Key</button>
                        <span id="testResult" style="font-size:13px;font-weight:600;"></span>
                    </div>
                </div>

                <!-- Model & Rate Limiting -->
                <div class="card">
                    <div class="card-header">
                        <h2>Model &amp; Rate Limiting</h2>
                    </div>
                    <div class="form-group">
                        <label for="defaultModel">Default Model</label>
                        <select id="defaultModel"></select>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="allowUserModel" checked>
                        <label for="allowUserModel">Allow users to select their own model</label>
                    </div>
                    <div class="form-group">
                        <label for="rateLimit">Rate Limit (requests per hour)</label>
                        <input type="number" id="rateLimit" value="0" min="0" step="1">
                        <div class="hint">Set to 0 for unlimited requests.</div>
                    </div>
                </div>

                <!-- Save Configuration -->
                <div class="card">
                    <div id="saveAlert" class="alert"></div>
                    <div class="btn-row">
                        <button class="btn btn-primary" onclick="saveConfig()">Save Configuration</button>
                    </div>
                    <div style="font-size:12px;color:var(--text-secondary);margin-top:12px;">
                        Last updated: <span id="lastUpdated">--</span>
                    </div>
                </div>
            </div>

            <!-- ═══ TAB: USERS & RESUMES ═══ -->
            <div class="tab-content" id="tab-users">
                <div class="tab-header">
                    <h1>Users &amp; Resumes</h1>
                    <p>Browse users, view their tailoring jobs and resume content</p>
                </div>

                <!-- Search -->
                <div style="margin-bottom:20px;">
                    <input type="text" class="search-input" placeholder="Search users by name or email..."
                           oninput="filterUsers(this.value)" id="userSearchInput">
                </div>

                <!-- Users List -->
                <div class="card">
                    <div class="card-header">
                        <h2>All Users</h2>
                        <button class="btn btn-sm btn-secondary" onclick="loadUsersList()">Refresh</button>
                    </div>
                    <div id="usersList" style="max-height:500px;overflow-y:auto;">
                        <div class="empty-state">
                            <div class="empty-icon">&#128101;</div>
                            <div>Loading users...</div>
                        </div>
                    </div>
                </div>

                <!-- User Jobs Detail (hidden by default) -->
                <div class="card" id="userJobsPanel" style="display:none;">
                    <div class="card-header">
                        <h2 id="userJobsTitle">User Jobs</h2>
                        <button class="btn btn-sm btn-secondary" onclick="closeUserJobs()">Back to Users</button>
                    </div>
                    <div id="userJobsList"></div>
                </div>

                <!-- Resume Viewer (hidden by default) -->
                <div class="card" id="resumeViewerPanel" style="display:none;">
                    <div class="card-header">
                        <h2 id="resumeViewerTitle">Resume Content</h2>
                        <button class="btn btn-sm btn-secondary" onclick="closeResumeViewer()">Close</button>
                    </div>
                    <div class="resume-tabs">
                        <button class="resume-tab-btn active" id="btnViewTailored" onclick="showResumeTab('tailored')">Tailored Resume</button>
                        <button class="resume-tab-btn" id="btnViewTalking" onclick="showResumeTab('talking')">Talking Points</button>
                    </div>
                    <div id="resumeContent" style="max-height:600px;overflow-y:auto;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:20px;font-size:13px;line-height:1.7;white-space:pre-wrap;font-family:'Inter',monospace;"></div>
                </div>
            </div>

            <!-- ═══ TAB: ANALYTICS ═══ -->
            <div class="tab-content" id="tab-analytics">
                <div class="tab-header">
                    <h1>Analytics</h1>
                    <p>Token usage and estimated cost across all pipeline runs</p>
                </div>

                <!-- Summary Cards -->
                <div class="metrics-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="metric-card">
                        <div class="metric-icon purple">&#128196;</div>
                        <div class="metric-value" id="analyticsJobs">--</div>
                        <div class="metric-label">Total Jobs</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon blue">&#128290;</div>
                        <div class="metric-value" id="analyticsTokens">--</div>
                        <div class="metric-label">Total Tokens</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon green">&#128176;</div>
                        <div class="metric-value" id="analyticsCost">--</div>
                        <div class="metric-label">Est. Cost (USD)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon orange">&#128178;</div>
                        <div class="metric-value" id="analyticsAvgCost">--</div>
                        <div class="metric-label">Avg Cost / Job</div>
                    </div>
                </div>

                <!-- Usage by Model Table -->
                <div class="card">
                    <div class="card-header">
                        <h2>Usage by Model</h2>
                        <button class="btn btn-sm btn-secondary" onclick="loadAnalytics()">Refresh</button>
                    </div>
                    <div id="analyticsModelTable">
                        <div style="color:var(--text-secondary);font-size:13px;">No data yet.</div>
                    </div>
                </div>
            </div>

            <!-- ═══ TAB: ERRORS ═══ -->
            <div class="tab-content" id="tab-errors">
                <div class="tab-header">
                    <h1>Pipeline Errors</h1>
                    <p>Last 50 errors (most recent first). Shows which model failed and why.</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>Error Log</h2>
                        <button class="btn btn-sm btn-secondary" onclick="loadErrors()">Refresh</button>
                    </div>
                    <div id="errorLog" style="max-height:600px;overflow-y:auto;">
                        <div style="color:var(--text-secondary);font-size:13px;">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- ═══ TAB: SYSTEM ═══ -->
            <div class="tab-content" id="tab-system">
                <div class="tab-header">
                    <h1>System Status</h1>
                    <p><span class="live-dot"></span>Live metrics &mdash; auto-refreshes every 10 seconds</p>
                </div>

                <div class="sys-grid">
                    <div class="sys-stat">
                        <div class="sys-val" id="sysActivePipelines">--</div>
                        <div class="sys-label">Active Pipelines</div>
                    </div>
                    <div class="sys-stat">
                        <div class="sys-val" id="sysQueueDepth">--</div>
                        <div class="sys-label">Queue Depth</div>
                    </div>
                    <div class="sys-stat">
                        <div class="sys-val" id="sysMemory">--</div>
                        <div class="sys-label">Memory Usage</div>
                    </div>
                    <div class="sys-stat">
                        <div class="sys-val" id="sysThreads">--</div>
                        <div class="sys-label">Thread Count</div>
                    </div>
                    <div class="sys-stat">
                        <div class="sys-val" id="sysMaxConcurrent">--</div>
                        <div class="sys-label">Max Concurrent</div>
                    </div>
                    <div class="sys-stat">
                        <div class="sys-val" id="sysMaxQueue">--</div>
                        <div class="sys-label">Max Queue Depth</div>
                    </div>
                </div>

                <div class="card" style="margin-top:20px;">
                    <div class="card-header">
                        <h2>Service Info</h2>
                        <button class="btn btn-sm btn-secondary" onclick="loadLiveStats()">Refresh Now</button>
                    </div>
                    <div style="font-size:13px;color:var(--text-secondary);">
                        System metrics update automatically every 10 seconds while this tab is active.
                        Pipeline concurrency and queue limits are configured via server environment variables.
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
    // ─── Tab Management ───

    var activeTab = 'dashboard';
    var systemRefreshInterval = null;
    var cachedUsersData = null;

    function switchTab(tabName) {
        // Hide all tabs
        var tabs = document.querySelectorAll('.tab-content');
        for (var i = 0; i < tabs.length; i++) {
            tabs[i].classList.remove('active');
        }
        // Show target
        var target = document.getElementById('tab-' + tabName);
        if (target) target.classList.add('active');

        // Update nav active state
        var items = document.querySelectorAll('.nav-item[data-tab]');
        for (var i = 0; i < items.length; i++) {
            items[i].classList.remove('active');
            if (items[i].dataset.tab === tabName) {
                items[i].classList.add('active');
            }
        }

        activeTab = tabName;

        // Start/stop system auto-refresh
        if (tabName === 'system') {
            startSystemRefresh();
        } else {
            stopSystemRefresh();
        }

        // Close mobile menu if open
        var sidebar = document.getElementById('sidebarNav');
        if (sidebar) sidebar.classList.remove('mobile-open');
    }

    function toggleMobileMenu() {
        var sidebar = document.getElementById('sidebarNav');
        if (sidebar) sidebar.classList.toggle('mobile-open');
    }

    // ─── System Auto-Refresh ───

    function startSystemRefresh() {
        loadLiveStats();
        systemRefreshInterval = setInterval(loadLiveStats, 10000);
    }

    function stopSystemRefresh() {
        if (systemRefreshInterval) {
            clearInterval(systemRefreshInterval);
            systemRefreshInterval = null;
        }
    }

    async function loadLiveStats() {
        try {
            var r = await fetch('/admin/api/live-stats');
            if (!r.ok) return;
            var d = await r.json();
            document.getElementById('sysActivePipelines').textContent = d.active_pipelines;
            document.getElementById('sysQueueDepth').textContent = d.queue_depth;
            document.getElementById('sysMemory').textContent = d.memory_mb + ' MB';
            document.getElementById('sysThreads').textContent = d.thread_count;
            document.getElementById('sysMaxConcurrent').textContent = d.max_concurrent;
            document.getElementById('sysMaxQueue').textContent = d.max_queue_depth;
            // Update dashboard pipeline count too
            var dp = document.getElementById('dashPipelines');
            if (dp) dp.textContent = d.active_pipelines + '/' + d.max_concurrent;
        } catch(e) {}
    }

    // ─── User Search ───

    function filterUsers(query) {
        var items = document.querySelectorAll('.user-card');
        query = query.toLowerCase();
        items.forEach(function(item) {
            var name = item.dataset.name || '';
            var email = item.dataset.email || '';
            item.style.display = (name.includes(query) || email.includes(query)) ? '' : 'none';
        });
    }

    // ─── Auth ───

    async function checkAuth() {
        try {
            var r = await fetch('/admin/api/config');
            if (r.ok) {
                showConfigPanel(await r.json());
                return;
            }
        } catch(e) {}
        // Not authenticated - show login or set password
        try {
            var r = await fetch('/api/status');
            var d = await r.json();
            if (d.has_admin_password) {
                document.getElementById('loginCard').style.display = 'block';
                document.getElementById('setPasswordCard').style.display = 'none';
            } else {
                document.getElementById('setPasswordCard').style.display = 'block';
                document.getElementById('loginCard').style.display = 'none';
            }
        } catch(e) {
            document.getElementById('setPasswordCard').style.display = 'block';
        }
        document.getElementById('authSection').style.display = 'flex';
        document.getElementById('configSection').style.display = 'none';
    }

    async function setPassword() {
        var pw = document.getElementById('newPassword').value;
        var pw2 = document.getElementById('confirmPassword').value;
        var alert = document.getElementById('setPasswordAlert');
        if (!pw || pw.length < 4) {
            alert.className = 'alert error'; alert.textContent = 'Password must be at least 4 characters.';
            return;
        }
        if (pw !== pw2) {
            alert.className = 'alert error'; alert.textContent = 'Passwords do not match.';
            return;
        }
        try {
            var r = await fetch('/admin/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({password: pw})
            });
            var d = await r.json();
            if (r.ok) {
                checkAuth();
            } else {
                alert.className = 'alert error'; alert.textContent = d.error || 'Failed to set password.';
            }
        } catch(e) {
            alert.className = 'alert error'; alert.textContent = 'Network error.';
        }
    }

    async function login() {
        var pw = document.getElementById('loginPassword').value;
        var alert = document.getElementById('loginAlert');
        if (!pw) {
            alert.className = 'alert error'; alert.textContent = 'Please enter a password.';
            return;
        }
        try {
            var r = await fetch('/admin/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({password: pw})
            });
            var d = await r.json();
            if (r.ok) {
                checkAuth();
            } else {
                alert.className = 'alert error'; alert.textContent = d.error || 'Invalid password.';
            }
        } catch(e) {
            alert.className = 'alert error'; alert.textContent = 'Network error.';
        }
    }

    async function logout() {
        stopSystemRefresh();
        await fetch('/admin/api/logout', {method: 'POST'});
        document.getElementById('configSection').style.display = 'none';
        var loginPw = document.getElementById('loginPassword');
        if (loginPw) loginPw.value = '';
        checkAuth();
    }

    // ─── Config Panel ───

    function showConfigPanel(config) {
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('configSection').style.display = 'block';

        // Populate fields
        document.getElementById('apiKeyInput').value = config.api_key || '';
        document.getElementById('allowUserModel').checked = config.allow_user_model_selection !== false;
        document.getElementById('rateLimit').value = config.rate_limit_per_hour || 0;
        document.getElementById('lastUpdated').textContent = config.updated_at || 'Never';

        // Update dashboard API status
        var hasKey = config.api_key && config.api_key.length > 3;
        var dashApi = document.getElementById('dashApiStatus');
        if (dashApi) {
            dashApi.textContent = hasKey ? 'Active' : 'Missing';
            dashApi.className = 'metric-value ' + (hasKey ? 'status-good' : 'status-bad');
        }

        loadModels(config.default_model);
        loadUsage();
        loadAnalytics();
        loadErrors();
        loadUsersList();
        loadLiveStats();
        switchTab('dashboard');
    }

    async function loadModels(selectedModel) {
        try {
            var r = await fetch('/api/models');
            var d = await r.json();
            var select = document.getElementById('defaultModel');
            var free = d.models.filter(function(m) { return m.name.includes('(Free)') || m.name.includes('(Auto)'); });
            var paid = d.models.filter(function(m) { return !m.name.includes('(Free)') && !m.name.includes('(Auto)'); });
            var chosen = selectedModel || d.default;
            var html = '<optgroup label="Free (no credits needed)">';
            free.forEach(function(m) {
                html += '<option value="' + m.id + '"' + (m.id === chosen ? ' selected' : '') + '>' + m.name + '</option>';
            });
            html += '</optgroup><optgroup label="Paid (requires credits)">';
            paid.forEach(function(m) {
                html += '<option value="' + m.id + '"' + (m.id === chosen ? ' selected' : '') + '>' + m.name + '</option>';
            });
            html += '</optgroup>';
            select.innerHTML = html;
        } catch(e) {
            console.error('Failed to load models:', e);
        }
    }

    async function loadUsage() {
        try {
            var r = await fetch('/admin/api/usage');
            if (!r.ok) return;
            var d = await r.json();
            var reqHour = d.requests_last_hour || 0;
            // Update dashboard
            var dr = document.getElementById('dashRequests');
            if (dr) dr.textContent = reqHour;
        } catch(e) {}
    }

    async function loadAnalytics() {
        try {
            var r = await fetch('/admin/api/analytics');
            if (!r.ok) return;
            var d = await r.json();

            // Summary numbers
            var totalJobs = d.total_jobs || 0;
            document.getElementById('analyticsJobs').textContent = totalJobs;

            var tokens = d.total_tokens || 0;
            document.getElementById('analyticsTokens').textContent =
                tokens >= 1000000 ? (tokens / 1000000).toFixed(1) + 'M' :
                tokens >= 1000 ? (tokens / 1000).toFixed(1) + 'K' :
                tokens;

            var cost = d.total_cost_usd || 0;
            document.getElementById('analyticsCost').textContent = '$' + cost.toFixed(4);

            var avg = d.avg_cost_per_job || 0;
            document.getElementById('analyticsAvgCost').textContent = '$' + avg.toFixed(4);

            // Update dashboard metrics
            var dj = document.getElementById('dashJobs');
            if (dj) dj.textContent = totalJobs;
            var dc = document.getElementById('dashCost');
            if (dc) dc.textContent = '$' + cost.toFixed(2);

            // Model breakdown table
            var tableEl = document.getElementById('analyticsModelTable');
            var models = d.jobs_by_model || {};
            var tokensByModel = d.tokens_by_model || {};
            var modelNames = Object.keys(models);

            if (modelNames.length === 0) {
                tableEl.innerHTML = '<div style="color:var(--text-secondary);font-size:13px;">No completed jobs yet.</div>';
                return;
            }

            // Sort by job count descending
            modelNames.sort(function(a, b) { return (models[b] || 0) - (models[a] || 0); });
            var maxJobs = Math.max.apply(null, modelNames.map(function(m) { return models[m] || 0; }));
            if (maxJobs < 1) maxJobs = 1;

            var html = '<table class="analytics-table">';
            html += '<thead><tr><th>Model</th><th class="num">Jobs</th><th class="num">Tokens</th><th style="width:30%"></th></tr></thead>';
            html += '<tbody>';
            modelNames.forEach(function(model) {
                var jobs = models[model] || 0;
                var toks = tokensByModel[model] || 0;
                var barWidth = Math.max(2, Math.round((jobs / maxJobs) * 100));
                var shortName = model.split('/').pop().replace(/:free$/, ' (free)');
                var tokStr = toks >= 1000000 ? (toks / 1000000).toFixed(1) + 'M' :
                             toks >= 1000 ? (toks / 1000).toFixed(1) + 'K' : toks;
                html += '<tr>';
                html += '<td title="' + model + '" style="font-weight:500;">' + shortName + '</td>';
                html += '<td class="num">' + jobs + '</td>';
                html += '<td class="num">' + tokStr + '</td>';
                html += '<td><span class="analytics-bar" style="width:' + barWidth + '%"></span></td>';
                html += '</tr>';
            });
            html += '</tbody></table>';
            tableEl.innerHTML = html;
        } catch(e) {
            console.error('Failed to load analytics:', e);
        }
    }

    // ─── Actions ───

    function toggleApiKeyVisibility() {
        var input = document.getElementById('apiKeyInput');
        var btn = document.getElementById('eyeBtn');
        if (input.type === 'password') {
            input.type = 'text'; btn.textContent = 'Hide';
        } else {
            input.type = 'password'; btn.textContent = 'Show';
        }
    }

    async function testApiKey() {
        var key = document.getElementById('apiKeyInput').value.trim();
        var result = document.getElementById('testResult');
        if (!key) {
            result.style.color = 'var(--error)'; result.textContent = 'Enter a key first.';
            return;
        }
        result.style.color = 'var(--text-secondary)'; result.textContent = 'Testing...';
        try {
            var r = await fetch('/admin/api/test-key', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({api_key: key})
            });
            var d = await r.json();
            if (d.valid) {
                result.style.color = 'var(--success)'; result.textContent = 'Valid key!';
            } else {
                result.style.color = 'var(--error)'; result.textContent = d.error || 'Invalid key.';
            }
        } catch(e) {
            result.style.color = 'var(--error)'; result.textContent = 'Test failed.';
        }
    }

    async function saveConfig() {
        var alert = document.getElementById('saveAlert');
        var payload = {
            api_key: document.getElementById('apiKeyInput').value.trim(),
            default_model: document.getElementById('defaultModel').value,
            allow_user_model_selection: document.getElementById('allowUserModel').checked,
            rate_limit_per_hour: parseInt(document.getElementById('rateLimit').value) || 0
        };
        try {
            var r = await fetch('/admin/api/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            var d = await r.json();
            if (r.ok) {
                alert.className = 'alert success'; alert.textContent = 'Configuration saved successfully.';
                // Refresh dashboard API status
                var hasKey = payload.api_key.length > 0;
                var dashApi = document.getElementById('dashApiStatus');
                if (dashApi) {
                    dashApi.textContent = hasKey ? 'Active' : 'Missing';
                    dashApi.className = 'metric-value ' + (hasKey ? 'status-good' : 'status-bad');
                }
                document.getElementById('lastUpdated').textContent = d.updated_at || 'Just now';
            } else {
                alert.className = 'alert error'; alert.textContent = d.error || 'Save failed.';
            }
        } catch(e) {
            alert.className = 'alert error'; alert.textContent = 'Network error.';
        }
        setTimeout(function() { alert.className = 'alert'; }, 5000);
    }

    function escapeHtml(s) {
        var d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
    }

    async function loadErrors() {
        try {
            var r = await fetch('/admin/api/errors');
            if (!r.ok) return;
            var d = await r.json();
            var el = document.getElementById('errorLog');
            if (!el) return;
            if (!d.errors || d.errors.length === 0) {
                el.innerHTML = '<div class="empty-state"><div class="empty-icon">&#9989;</div><div>No errors recorded. Everything is running smoothly.</div></div>';
                return;
            }
            el.innerHTML = d.errors.map(function(e) {
                return '<div style="background:rgba(225,112,85,0.05);border:1px solid rgba(225,112,85,0.15);border-radius:10px;padding:14px;margin-bottom:8px;">' +
                '<div style="font-size:11px;color:var(--text-secondary);">' + escapeHtml(e.time) + ' &middot; <strong style="color:var(--text);">' + escapeHtml(e.model) + '</strong></div>' +
                '<div style="font-size:13px;color:var(--error);margin-top:6px;line-height:1.5;">' + escapeHtml(e.error) + '</div>' +
                '</div>';
            }).join('');
        } catch(e) {}
    }

    // ─── Users & Resumes Browser ───

    var currentJobsData = null;

    async function loadUsersList() {
        try {
            var r = await fetch('/admin/api/users');
            if (!r.ok) return;
            var d = await r.json();
            cachedUsersData = d.users || [];
            var el = document.getElementById('usersList');
            if (!d.users || d.users.length === 0) {
                el.innerHTML = '<div class="empty-state"><div class="empty-icon">&#128101;</div><div>No users yet.</div></div>';
                // Update dashboard
                var du = document.getElementById('dashUsers');
                if (du) du.textContent = '0';
                return;
            }

            // Update dashboard user count
            var du = document.getElementById('dashUsers');
            if (du) du.textContent = d.users.length;

            el.innerHTML = d.users.map(function(u) {
                var initials = (u.name || u.email || '?').substring(0, 2).toUpperCase();
                var pic = u.picture
                    ? '<img src="' + u.picture + '" style="width:36px;height:36px;border-radius:50%;object-fit:cover;" alt="">'
                    : '<div class="activity-avatar">' + initials + '</div>';
                return '<div class="user-card" data-name="' + (u.name || '').toLowerCase() + '" data-email="' + (u.email || '').toLowerCase() + '" onclick="loadUserJobs(\'' + u.id + '\')">' +
                    pic +
                    '<div style="flex:1;min-width:0;">' +
                        '<div style="font-size:14px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (u.name || 'Unknown') + '</div>' +
                        '<div style="font-size:12px;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (u.email || '') + '</div>' +
                    '</div>' +
                    '<div style="text-align:right;">' +
                        '<div style="font-size:18px;font-weight:800;color:var(--accent);">' + u.jobs_count + '</div>' +
                        '<div style="font-size:11px;color:var(--text-secondary);">jobs</div>' +
                    '</div>' +
                '</div>';
            }).join('');

            // Populate recent activity on dashboard (last 5 signups)
            populateRecentActivity(d.users);
        } catch(e) {
            console.error('Failed to load users:', e);
        }
    }

    function populateRecentActivity(users) {
        var el = document.getElementById('recentActivity');
        if (!el) return;
        // Take last 5 (most recent at end of array, or we show the last 5 from the list)
        var recent = users.slice(-5).reverse();
        if (recent.length === 0) {
            el.innerHTML = '<div class="empty-state"><div class="empty-icon">&#128101;</div><div>No users yet.</div></div>';
            return;
        }
        el.innerHTML = recent.map(function(u) {
            var initials = (u.name || u.email || '?').substring(0, 2).toUpperCase();
            var pic = u.picture
                ? '<div class="activity-avatar"><img src="' + u.picture + '" alt=""></div>'
                : '<div class="activity-avatar">' + initials + '</div>';
            return '<div class="activity-item">' +
                pic +
                '<div style="flex:1;min-width:0;">' +
                    '<div style="font-size:14px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (u.name || 'Unknown') + '</div>' +
                    '<div style="font-size:12px;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (u.email || '') + '</div>' +
                '</div>' +
                '<div style="font-size:13px;font-weight:600;color:var(--accent);">' + u.jobs_count + ' jobs</div>' +
            '</div>';
        }).join('');
    }

    async function loadUserJobs(userId) {
        try {
            var r = await fetch('/admin/api/user-jobs/' + userId);
            if (!r.ok) return;
            var d = await r.json();
            currentJobsData = d;
            document.getElementById('userJobsTitle').textContent = (d.user.name || d.user.email) + ' \u2014 Jobs';
            var el = document.getElementById('userJobsList');
            if (!d.jobs || d.jobs.length === 0) {
                el.innerHTML = '<div class="empty-state"><div class="empty-icon">&#128196;</div><div>No tailoring jobs for this user.</div></div>';
            } else {
                el.innerHTML = d.jobs.map(function(j, idx) {
                    var score = j.match_score ? Math.round(j.match_score) + '%' : '--';
                    var scoreColor = j.match_score >= 80 ? 'var(--success)' : j.match_score >= 50 ? '#F59E0B' : 'var(--error)';
                    var date = j.created_at ? new Date(j.created_at).toLocaleDateString() + ' ' + new Date(j.created_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '';
                    var duration = j.duration_seconds ? Math.round(j.duration_seconds) + 's' : '';
                    var hasResume = j.ats_resume_md ? true : false;
                    return '<div style="padding:14px;border:1px solid var(--border);border-radius:10px;margin-bottom:8px;transition:all 0.15s;' + (j.status === 'error' ? 'border-left:3px solid var(--error);' : hasResume ? 'border-left:3px solid var(--success);' : '') + '">' +
                        '<div style="display:flex;justify-content:space-between;align-items:start;gap:12px;">' +
                            '<div style="flex:1;min-width:0;">' +
                                '<div style="font-size:14px;font-weight:700;">' + (j.job_title || 'Untitled') + (j.company ? ' <span style="font-weight:400;color:var(--text-secondary);">at ' + j.company + '</span>' : '') + '</div>' +
                                '<div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">' + date + (duration ? ' &middot; ' + duration : '') + ' &middot; ' + (j.model_used || 'unknown model') + ' &middot; ' + (j.rewrite_mode || '') + '</div>' +
                                (j.job_description_snippet ? '<div style="font-size:12px;color:var(--text-secondary);margin-top:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:500px;">' + j.job_description_snippet + '</div>' : '') +
                                (j.error_message ? '<div style="font-size:12px;color:var(--error);margin-top:6px;">' + j.error_message + '</div>' : '') +
                            '</div>' +
                            '<div style="text-align:right;flex-shrink:0;">' +
                                '<div style="font-size:20px;font-weight:800;color:' + scoreColor + ';">' + score + '</div>' +
                                (hasResume ? '<button class="btn btn-sm" onclick="viewResume(' + idx + ')" style="margin-top:6px;background:var(--accent);color:#fff;font-size:11px;padding:4px 10px;">View Resume</button>' : '<span style="font-size:11px;color:var(--text-secondary);">' + j.status + '</span>') +
                            '</div>' +
                        '</div>' +
                    '</div>';
                }).join('');
            }
            document.getElementById('userJobsPanel').style.display = 'block';
            document.getElementById('userJobsPanel').scrollIntoView({behavior: 'smooth'});
        } catch(e) {
            console.error('Failed to load user jobs:', e);
        }
    }

    function closeUserJobs() {
        document.getElementById('userJobsPanel').style.display = 'none';
        document.getElementById('resumeViewerPanel').style.display = 'none';
        currentJobsData = null;
    }

    function viewResume(jobIdx) {
        if (!currentJobsData || !currentJobsData.jobs[jobIdx]) return;
        var job = currentJobsData.jobs[jobIdx];
        document.getElementById('resumeViewerTitle').textContent = (job.job_title || 'Resume') + (job.company ? ' \u2014 ' + job.company : '');
        document.getElementById('resumeViewerPanel').style.display = 'block';
        showResumeTab('tailored');
        document.getElementById('resumeViewerPanel').scrollIntoView({behavior: 'smooth'});
        // Store job index for tab switching
        document.getElementById('resumeViewerPanel').dataset.jobIdx = jobIdx;
    }

    function showResumeTab(tab) {
        var idx = parseInt(document.getElementById('resumeViewerPanel').dataset.jobIdx || '0');
        if (!currentJobsData || !currentJobsData.jobs[idx]) return;
        var job = currentJobsData.jobs[idx];
        var content = document.getElementById('resumeContent');
        var btnTailored = document.getElementById('btnViewTailored');
        var btnTalking = document.getElementById('btnViewTalking');
        if (tab === 'tailored') {
            content.textContent = job.ats_resume_md || 'No resume content available.';
            btnTailored.classList.add('active');
            btnTalking.classList.remove('active');
        } else {
            content.textContent = job.talking_points_md || 'No talking points available.';
            btnTalking.classList.add('active');
            btnTailored.classList.remove('active');
        }
    }

    function closeResumeViewer() {
        document.getElementById('resumeViewerPanel').style.display = 'none';
    }

    // ─── Init ───
    checkAuth();
    </script>
</body>
</html>
