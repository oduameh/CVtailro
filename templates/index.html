<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>CVtailro -- AI Resume Tailoring</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231B2559' width='100' height='100' rx='20'/><text x='50' y='68' font-size='60' font-weight='bold' text-anchor='middle' fill='%2300B37E' font-family='system-ui'>CV</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CVtailro">
    <meta name="theme-color" content="#1B2559">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231B2559' width='100' height='100' rx='20'/><text x='50' y='68' font-size='60' font-weight='bold' text-anchor='middle' fill='%2300B37E' font-family='system-ui'>CV</text></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        :root {
            --primary: #1B2559;
            --primary-light: #2D3A8C;
            --accent: #00B37E;
            --accent-hover: #00995A;
            --accent-light: #E6F9F1;
            --score-high: #00B37E;
            --score-mid: #F59E0B;
            --score-low: #EF4444;
            --bg: #F7F8FC;
            --card: #FFFFFF;
            --border: #E2E8F0;
            --text: #1A1D2E;
            --text-secondary: #6B7280;
            --error: #EF4444;
            --radius: 10px;
        }

        html { scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* Prevent iOS zoom on input focus â€” inputs < 16px trigger auto-zoom */
        input, textarea, select { font-size: 16px !important; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            font-size: 15px;
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* --- Sticky Header --- */
        .site-header {
            position: sticky;
            top: 0;
            z-index: 100;
            height: 64px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }

        .site-logo {
            font-size: 20px;
            font-weight: 800;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0;
        }

        .site-logo .cv { color: var(--accent); }
        .site-logo .tailro { color: var(--primary); }

        .header-cta {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 8px 18px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.2s;
        }

        .header-cta:hover { background: var(--accent-hover); }

        /* --- Hero Section --- */
        .hero {
            background: linear-gradient(135deg, #0F1629 0%, #1B2559 50%, #2D3A8C 100%);
            color: #fff;
            text-align: center;
            padding: 80px 24px 72px;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 30%;
            left: 50%;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(0, 179, 126, 0.08) 0%, transparent 70%);
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .hero-inner {
            position: relative;
            z-index: 1;
            max-width: 640px;
            margin: 0 auto;
        }

        .hero h1 {
            font-size: 44px;
            font-weight: 800;
            letter-spacing: -1.5px;
            line-height: 1.1;
            margin-bottom: 20px;
        }

        .hero-sub {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.6;
            font-weight: 400;
            max-width: 540px;
            margin: 0 auto;
        }

        /* --- Trust Bar --- */
        .trust-bar {
            background: var(--bg);
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            text-align: center;
            padding: 14px 24px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .trust-bar span {
            margin: 0 6px;
            color: #D1D5DB;
        }

        /* --- Container --- */
        .container {
            max-width: 920px;
            margin: 0 auto;
            padding: 32px 24px 60px;
        }

        /* --- Cards --- */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 28px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .card h2 {
            font-size: 15px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 20px;
        }

        /* --- Form Layout: side by side --- */
        .form-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 0;
        }

        .form-columns .card {
            margin-bottom: 0;
        }

        /* --- Upload Zone --- */
        .upload-zone {
            border: 2px dashed #CBD5E1;
            border-radius: var(--radius);
            padding: 48px 28px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            position: relative;
            background: #FAFBFE;
        }

        .upload-zone:hover {
            border-color: var(--accent);
            background: var(--accent-light);
        }

        .upload-zone.dragover {
            border-color: var(--accent);
            background: var(--accent-light);
        }

        .upload-zone.has-file {
            border-color: var(--accent);
            background: var(--accent-light);
        }

        .upload-zone input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-icon svg {
            width: 40px;
            height: 40px;
            color: var(--text-secondary);
        }

        .upload-zone.has-file .upload-icon svg {
            color: var(--accent);
        }

        .upload-label {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .upload-label strong {
            color: var(--accent);
            font-weight: 600;
        }

        .upload-privacy {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .upload-privacy svg {
            width: 12px;
            height: 12px;
            flex-shrink: 0;
        }

        .file-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
            margin-top: 10px;
        }

        /* --- Textarea --- */
        textarea {
            width: 100%;
            min-height: 200px;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            color: var(--text);
            background: #fff;
        }

        textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 179, 126, 0.1);
        }

        textarea::placeholder { color: #94A3B8; }

        textarea.input-error {
            border-color: var(--error);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        .char-count {
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .inline-error {
            color: var(--error);
            font-size: 12px;
            font-weight: 500;
            margin-top: 6px;
            display: none;
        }

        .inline-error.visible { display: block; }

        /* --- Controls Row --- */
        .controls-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 20px;
            margin-bottom: 0;
            flex-wrap: wrap;
        }

        .toggle-group {
            display: flex;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .toggle-group label {
            padding: 10px 18px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            white-space: nowrap;
            min-height: 44px;
            display: flex;
            align-items: center;
            color: var(--text-secondary);
            background: #fff;
        }

        .toggle-group input { display: none; }

        .toggle-group input:checked + label {
            background: var(--primary);
            color: #fff;
        }

        .toggle-group label:hover {
            background: #F1F5F9;
        }

        .toggle-group input:checked + label:hover {
            background: var(--primary-light);
        }

        /* --- CTA Row --- */
        .cta-row {
            margin-top: 20px;
            text-align: center;
        }

        .btn-run {
            width: 100%;
            max-width: 420px;
            padding: 14px 24px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            min-height: 44px;
        }

        .btn-run:hover:not(:disabled) {
            background: var(--accent-hover);
            box-shadow: 0 4px 16px rgba(0, 179, 126, 0.25);
        }

        .btn-run:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .cta-hint {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        /* --- Error Banner --- */
        .error-banner {
            display: none;
            padding: 14px 18px;
            background: #FEE2E2;
            color: var(--error);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 20px;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .error-banner.active { display: flex; }

        .error-banner-msg { flex: 1; }

        .error-close {
            background: none;
            border: none;
            color: var(--error);
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            line-height: 1;
            font-weight: 700;
            flex-shrink: 0;
            transition: background 0.15s;
        }

        .error-close:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* --- Progress Section --- */
        .progress-section { display: none; }
        .progress-section.active { display: block; }

        .progress-wrap {
            max-width: 520px;
            margin: 0 auto;
            text-align: center;
        }

        .progress-current-stage {
            font-size: 15px;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 16px;
        }

        .progress-bar-track {
            width: 100%;
            height: 6px;
            background: #E2E8F0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-bar-fill {
            width: 0%;
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .progress-pct {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 16px;
        }

        .time-estimate {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .tip-container {
            text-align: center;
            margin-bottom: 28px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tip-text {
            font-size: 13px;
            color: var(--text-secondary);
            font-style: italic;
            line-height: 1.5;
            transition: opacity 0.5s ease;
        }

        .stage-list {
            text-align: left;
            max-width: 400px;
            margin: 0 auto;
        }

        .stage {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .stage-check {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 12px;
        }

        .stage-check.pending {
            color: #D1D5DB;
        }

        .stage-check.running {
            color: var(--accent);
        }

        .stage-check.done {
            color: var(--accent);
        }

        .stage-check.error {
            color: var(--error);
        }

        .stage-name {
            font-weight: 500;
        }

        .stage.is-done .stage-name {
            color: var(--text-secondary);
        }

        .stage.is-running .stage-name {
            color: var(--text);
            font-weight: 600;
        }

        /* --- Results Section --- */
        .results-section { display: none; }
        .results-section.active { display: block; }

        /* --- Circular Score --- */
        .score-section {
            text-align: center;
            margin-bottom: 28px;
        }

        .score-ring-wrap {
            display: inline-block;
            position: relative;
            width: 140px;
            height: 140px;
            margin-bottom: 8px;
        }

        .score-ring-wrap svg {
            width: 140px;
            height: 140px;
            transform: rotate(-90deg);
        }

        .score-ring-bg {
            fill: none;
            stroke: #E2E8F0;
            stroke-width: 10;
        }

        .score-ring-fill {
            fill: none;
            stroke-width: 10;
            stroke-linecap: round;
            transition: stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1), stroke 0.3s;
        }

        .score-ring-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            font-weight: 800;
            color: var(--text);
        }

        .score-ring-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .score-stats {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-top: 16px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .score-stats strong {
            color: var(--text);
            font-weight: 700;
        }

        /* --- Keywords --- */
        .keywords-section {
            margin-top: 20px;
        }

        .keywords-section-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .kw {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 600;
        }

        .kw-matched {
            background: var(--accent-light);
            color: #047857;
            border: 1px solid #A7F3D0;
        }

        .kw-missing {
            background: #FEF2F2;
            color: #B91C1C;
            border: 1px solid #FECACA;
        }

        /* --- Downloads --- */
        .downloads-heading {
            font-size: 15px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 20px;
        }

        .dl-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .dl-card {
            display: block;
            text-decoration: none;
            background: #FAFBFE;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .dl-card:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 8px rgba(0, 179, 126, 0.1);
        }

        .dl-card-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }

        .dl-card-icon.ats {
            background: var(--accent-light);
            color: var(--accent);
        }

        .dl-card-icon.rec {
            background: #EDE9FE;
            color: #7C3AED;
        }

        .dl-card-icon svg {
            width: 20px;
            height: 20px;
        }

        .dl-card-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 4px;
        }

        .dl-card-desc {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .dl-card-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--accent);
            color: #fff;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }

        .dl-card.rec-card .dl-card-btn {
            background: #7C3AED;
        }

        .dl-usage-hint {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 20px;
        }

        /* --- Additional Files (collapsible) --- */
        .additional-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            background: none;
            border: none;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px 0;
            font-family: inherit;
        }

        .additional-toggle:hover { color: var(--text); }

        .additional-toggle svg {
            width: 14px;
            height: 14px;
            transition: transform 0.2s;
        }

        .additional-toggle.open svg {
            transform: rotate(90deg);
        }

        .additional-files {
            display: none;
            padding-top: 8px;
        }

        .additional-files.open {
            display: block;
        }

        .additional-files-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .dl-btn-secondary {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: #F1F5F9;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-decoration: none;
            transition: background 0.2s;
        }

        .dl-btn-secondary:hover {
            background: #E2E8F0;
        }

        .dl-btn-secondary .badge {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 2px 6px;
            border-radius: 3px;
            background: rgba(0, 0, 0, 0.06);
            color: var(--text-secondary);
        }

        /* --- Talking Points --- */
        .talking-points-card {
            background: #FAFBFE;
            border: 1px solid var(--border);
        }

        .talking-points-content {
            font-size: 14px;
            line-height: 1.7;
        }

        .talking-points-content h2 {
            font-size: 16px;
            font-weight: 700;
            margin: 16px 0 8px;
        }

        .talking-points-content h2:first-child { margin-top: 0; }
        .talking-points-content h3 { font-size: 14px; font-weight: 600; margin: 12px 0 6px; }
        .talking-points-content ul { padding-left: 20px; margin: 6px 0; }
        .talking-points-content li { margin-bottom: 4px; }
        .talking-points-content p { margin: 6px 0; }
        .talking-points-content strong { font-weight: 700; }

        /* --- Tabs / Preview --- */
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .preview-header h2 { margin-bottom: 0; }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 10px 18px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            color: var(--text-secondary);
            transition: color 0.2s, border-color 0.2s;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
            font-family: inherit;
        }

        .tab:hover { color: var(--text); }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
            max-height: 500px;
            overflow-y: auto;
            padding: 20px 24px;
            background: #fff;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.7;
        }

        .tab-content.active { display: block; }

        .tab-content h2 {
            font-size: 18px;
            font-weight: 700;
            margin: 20px 0 8px;
            color: var(--text);
        }

        .tab-content h2:first-child { margin-top: 0; }
        .tab-content h3 { font-size: 15px; font-weight: 600; margin: 16px 0 6px; color: var(--text); }
        .tab-content ul { padding-left: 20px; margin: 6px 0; }
        .tab-content li { margin-bottom: 4px; }
        .tab-content p { margin: 8px 0; }
        .tab-content strong { font-weight: 700; }

        .copy-btn {
            padding: 7px 14px;
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            font-family: inherit;
        }

        .copy-btn:hover { background: var(--primary-light); }

        /* --- Try Again --- */
        .again-wrap {
            text-align: center;
            margin-top: 32px;
        }

        .btn-again {
            padding: 12px 28px;
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            font-family: inherit;
        }

        .btn-again:hover { background: var(--primary-light); }

        /* --- Footer --- */
        .site-footer {
            background: linear-gradient(135deg, #0F1629, #1B2559);
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            padding: 40px 24px;
            font-size: 13px;
        }

        .footer-brand {
            font-size: 14px;
            color: #fff;
            margin-bottom: 12px;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 12px;
        }

        .footer-links a {
            color: rgba(255, 255, 255, 0.5);
            text-decoration: none;
            font-size: 13px;
            transition: color 0.2s;
        }

        .footer-links a:hover { color: rgba(255, 255, 255, 0.8); }

        .footer-copy {
            color: rgba(255, 255, 255, 0.35);
            font-size: 12px;
        }

        /* --- What Changed Panel --- */
        .changes-panel { padding: 20px; }
        .change-section { margin-bottom: 24px; }
        .change-section:last-child { margin-bottom: 0; }
        .change-section h3 { font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 10px; }
        .score-comparison { display: flex; align-items: center; gap: 12px; font-size: 18px; padding: 16px; background: #FAFBFE; border: 1px solid var(--border); border-radius: 8px; }
        .score-before { color: var(--score-low); font-weight: 600; }
        .score-after { color: var(--score-high); font-weight: 700; }
        .score-arrow { color: var(--text-secondary); font-size: 24px; }
        .score-delta { margin-left: auto; font-size: 14px; font-weight: 700; color: var(--score-high); background: var(--accent-light); padding: 4px 10px; border-radius: 4px; }
        .keywords-added-list { display: flex; flex-wrap: wrap; gap: 6px; }
        .kw-added { font-size: 12px; padding: 4px 10px; border-radius: 4px; font-weight: 600; background: var(--accent-light); color: #047857; border: 1px solid #A7F3D0; }
        .change-summary { font-size: 14px; line-height: 1.7; color: var(--text); padding: 16px; background: #FAFBFE; border: 1px solid var(--border); border-radius: 8px; }
        .change-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px; }
        .change-stat { text-align: center; padding: 16px 12px; background: #FAFBFE; border: 1px solid var(--border); border-radius: 8px; }
        .change-stat-value { font-size: 24px; font-weight: 800; color: var(--primary); line-height: 1.2; }
        .change-stat-label { font-size: 12px; color: var(--text-secondary); font-weight: 500; margin-top: 4px; }

        /* --- Mobile --- */
        @media (max-width: 768px) {
            .site-header {
                padding: 0 16px;
            }

            /* Hero: tighter padding on mobile */
            .hero {
                padding: 40px 16px 32px;
            }

            .hero h1 {
                font-size: 26px;
                letter-spacing: -0.5px;
            }

            .hero-sub {
                font-size: 15px;
            }

            /* Container: less padding on mobile */
            .container {
                padding: 16px 12px 32px;
            }

            /* Cards: tighter padding */
            .card {
                padding: 16px;
                margin-bottom: 16px;
            }

            /* Form layout: stack vertically */
            .form-columns {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            /* Upload zone: bigger touch target */
            .upload-zone {
                padding: 32px 20px;
                min-height: 120px;
            }

            /* Textarea: shorter on mobile */
            textarea { min-height: 140px; }

            /* Download cards: stack */
            .dl-cards {
                grid-template-columns: 1fr;
            }

            .dl-card {
                width: 100%;
            }

            /* Controls: stack vertically */
            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }

            .toggle-group {
                justify-content: center;
            }

            /* Toggle buttons: bigger touch targets */
            .toggle-group label {
                padding: 12px 16px;
                font-size: 14px;
                min-height: 44px;
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* CTA button: full width, bigger tap target */
            .btn-run {
                width: 100%;
                max-width: 100%;
                padding: 16px;
                font-size: 16px;
                min-height: 52px;
            }

            /* Score stats: stack */
            .score-stats {
                flex-direction: column;
                gap: 8px;
            }

            /* Progress section: tighter */
            .progress-wrap {
                padding: 0 4px;
            }

            .stage {
                padding: 8px 0;
            }

            /* Sticky progress bar while processing */
            .progress-section.active .progress-bar-track {
                position: sticky;
                top: 64px;
                z-index: 50;
                background: var(--card);
                padding: 8px 0;
                margin-left: -16px;
                margin-right: -16px;
                padding-left: 16px;
                padding-right: 16px;
            }

            /* Results preview: readable on small screens */
            .tab-content {
                font-size: 13px;
                padding: 12px;
            }

            /* What Changed: stack stats vertically */
            .change-stats {
                grid-template-columns: 1fr;
            }
            .score-comparison {
                flex-wrap: wrap;
                font-size: 16px;
            }
            .score-delta {
                margin-left: 0;
                margin-top: 4px;
            }

            /* User menu: compact on mobile */
            .user-menu-trigger {
                padding: 6px 8px;
            }

            .user-name-text {
                display: none;
            }

            /* Footer: tighter */
            .site-footer {
                padding: 24px 16px;
                font-size: 12px;
            }

            /* Trust bar: smaller text */
            .trust-bar {
                font-size: 12px;
                padding: 10px 16px;
            }
        }

        /* --- Auth Controls in Header --- */
        .header-auth {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-google-signin {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #fff;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.2s, box-shadow 0.2s;
            min-height: 40px;
            white-space: nowrap;
        }

        .btn-google-signin:hover {
            background: #F8F9FA;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .btn-google-signin svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        /* User menu (logged in state) */
        .user-menu-wrap {
            position: relative;
        }

        .user-menu-trigger {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 10px 4px 4px;
            background: none;
            border: 1px solid var(--border);
            border-radius: 24px;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
            transition: background 0.2s, border-color 0.2s;
            min-height: 40px;
        }

        .user-menu-trigger:hover {
            background: #F1F5F9;
            border-color: #CBD5E1;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-menu-chevron {
            width: 14px;
            height: 14px;
            transition: transform 0.2s;
            color: var(--text-secondary);
        }

        .user-menu-wrap.open .user-menu-chevron {
            transform: rotate(180deg);
        }

        .user-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            min-width: 200px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            z-index: 200;
            overflow: hidden;
        }

        .user-menu-wrap.open .user-dropdown {
            display: block;
        }

        .dropdown-user-info {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .dropdown-user-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .dropdown-user-email {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 10px 16px;
            background: none;
            border: none;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
            cursor: pointer;
            text-decoration: none;
            transition: background 0.15s;
            min-height: 44px;
        }

        .dropdown-item:hover {
            background: #F1F5F9;
        }

        .dropdown-item svg {
            width: 16px;
            height: 16px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: 0;
        }

        .dropdown-item.sign-out {
            color: var(--error);
        }

        .dropdown-item.sign-out svg {
            color: var(--error);
        }

        /* --- Toast Notification --- */
        .toast {
            position: fixed;
            top: 80px;
            right: 24px;
            z-index: 1000;
            max-width: 400px;
            padding: 14px 18px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transform: translateX(calc(100% + 24px));
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: auto;
        }

        .toast.visible {
            transform: translateX(0);
        }

        .toast.toast-error {
            background: #FEE2E2;
            color: #991B1B;
            border: 1px solid #FECACA;
        }

        .toast.toast-info {
            background: #DBEAFE;
            color: #1E40AF;
            border: 1px solid #BFDBFE;
        }

        .toast.toast-success {
            background: #ECFDF5;
            color: #065F46;
            border: 1px solid #A7F3D0;
        }

        /* --- History Overlay --- */
        .history-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 300;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        .history-overlay.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 80px 24px 24px;
        }

        .history-panel {
            background: #fff;
            border-radius: 12px;
            width: 100%;
            max-width: 640px;
            max-height: calc(100vh - 120px);
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .history-header h2 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            margin: 0;
        }

        .history-close {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: background 0.15s, color 0.15s;
            font-size: 20px;
        }

        .history-close:hover {
            background: #F1F5F9;
            color: var(--text);
        }

        .history-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px 24px;
        }

        .history-empty {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-secondary);
        }

        .history-empty-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            color: #D1D5DB;
        }

        .history-empty h3 {
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 6px;
        }

        .history-empty p {
            font-size: 13px;
        }

        .history-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s, background 0.15s;
            min-height: 44px;
        }

        .history-card:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 8px rgba(0, 179, 126, 0.1);
            background: #FAFBFE;
        }

        .history-card-score {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .history-card-score.high { background: #ECFDF5; color: #047857; }
        .history-card-score.mid { background: #FFFBEB; color: #B45309; }
        .history-card-score.low { background: #FEF2F2; color: #B91C1C; }

        .history-card-info {
            flex: 1;
            min-width: 0;
        }

        .history-card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-card-meta {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .history-card-arrow {
            width: 16px;
            height: 16px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .history-loading {
            text-align: center;
            padding: 40px 24px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* --- Elapsed Time in Progress --- */
        .elapsed-time {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            font-variant-numeric: tabular-nums;
        }

        .elapsed-time span {
            font-weight: 600;
            color: var(--text);
        }

        /* --- Reconnecting Indicator --- */
        .reconnecting-badge {
            display: none;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            justify-content: center;
        }

        .reconnecting-badge.visible {
            display: flex;
        }

        .reconnecting-badge .dot {
            width: 6px;
            height: 6px;
            background: var(--score-mid);
            border-radius: 50%;
            animation: pulse-dot 1.5s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* --- Small phones (iPhone SE, older Androids) --- */
        @media (max-width: 375px) {
            .hero h1 { font-size: 22px; }
            .hero-sub { font-size: 14px; }
            .toggle-group { flex-wrap: wrap; }
            .toggle-group label { flex: 1 1 auto; min-width: 80px; }
            .card { padding: 12px; }
            .container { padding: 12px 8px 24px; }
            .dl-card { padding: 14px; }
            .tab-content { font-size: 12px; padding: 10px; }
        }

        /* --- dvh viewport fix for mobile browsers (URL bar) --- */
        @supports (height: 100dvh) {
            .history-panel { height: 100dvh; }
        }

        /* --- Mobile: Auth & History --- */
        @media (max-width: 768px) {
            .btn-google-signin {
                padding: 8px 12px;
                font-size: 13px;
            }

            .btn-google-signin .signin-text-full {
                display: none;
            }

            .btn-google-signin .signin-text-short {
                display: inline;
            }

            .user-menu-trigger {
                padding: 4px 8px 4px 4px;
            }

            .user-menu-trigger .user-name-text {
                display: none;
            }

            .user-dropdown {
                right: -8px;
                min-width: 220px;
            }

            .history-overlay.active {
                padding: 0;
                align-items: stretch;
            }

            .history-panel {
                max-width: 100%;
                max-height: 100vh;
                border-radius: 0;
                height: 100vh;
            }

            .history-header {
                padding: 16px;
            }

            .history-body {
                padding: 12px 16px;
            }

            .toast {
                right: 12px;
                left: 12px;
                max-width: none;
            }
        }

        @media (min-width: 769px) {
            .btn-google-signin .signin-text-short {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="site-header">
        <a href="/" class="site-logo"><span class="cv">CV</span><span class="tailro">tailro</span></a>
        <div class="header-auth" id="headerAuth">
            <!-- Signed out state (default) -->
            <a href="/auth/google/login" class="btn-google-signin" id="btnGoogleSignin" style="display:none;">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.27-4.74 3.27-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                <span class="signin-text-full">Sign in with Google</span>
                <span class="signin-text-short">Sign in</span>
            </a>
            <!-- Signed in state (hidden by default) -->
            <div class="user-menu-wrap" id="userMenuWrap" style="display:none;">
                <button class="user-menu-trigger" onclick="toggleUserMenu(event)">
                    <div class="user-avatar" id="userAvatar"></div>
                    <span class="user-name-text" id="userNameText"></span>
                    <svg class="user-menu-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="user-dropdown" id="userDropdown">
                    <div class="dropdown-user-info">
                        <div class="dropdown-user-name" id="dropdownUserName"></div>
                        <div class="dropdown-user-email" id="dropdownUserEmail"></div>
                    </div>
                    <button class="dropdown-item" onclick="showHistory()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        History
                    </button>
                    <div class="dropdown-divider" id="adminDivider" style="display:none;"></div>
                    <a class="dropdown-item" id="adminLink" href="/admin" style="display:none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                        Admin Panel
                    </a>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item sign-out" onclick="signOut()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero -->
    <section class="hero">
        <div class="hero-inner">
            <h1>Make your resume stand out</h1>
            <p class="hero-sub">Upload your resume, paste any job description, and get an AI-optimized version in 2 minutes.</p>
        </div>
    </section>

    <!-- Trust Bar -->
    <div class="trust-bar">
        AI-powered resume optimization <span>&middot;</span> Sign in with Google to get started <span>&middot;</span> Your data stays private
    </div>

    <!-- Demo Banner -->
    <div style="background:#EFF6FF;border:1px solid #BFDBFE;border-radius:8px;padding:14px 18px;max-width:920px;margin:16px auto;text-align:center;font-size:14px;color:#1E40AF;">
        <strong>Live Demo</strong> â€” Tailor as many resumes as you want. Have your resume (PDF) and a job description ready.
    </div>

    <div class="container">
        <!-- Error Banner -->
        <div class="error-banner" id="errorBanner">
            <span class="error-banner-msg" id="errorMsg"></span>
            <button class="error-close" onclick="dismissError()" aria-label="Close">&times;</button>
        </div>

        <!-- Config Banner -->
        <div id="configBanner" style="display:none; padding: 14px 18px; background: #FEF3C7; color: #92400E;
             border: 1px solid #FCD34D; border-radius: 8px; font-size: 14px; margin-bottom: 20px;">
            Service is temporarily unavailable. Please try again later.
        </div>

        <!-- Form Section -->
        <div id="formSection">
            <div class="form-columns">
                <!-- Upload Card -->
                <div class="card" id="uploadCard">
                    <h2>Upload Your Resume</h2>
                    <div class="upload-zone" id="uploadZone">
                        <input type="file" id="resumeFile" accept=".pdf,.md,.txt">
                        <div class="upload-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="12" y1="18" x2="12" y2="12"/>
                                <polyline points="9 15 12 12 15 15"/>
                            </svg>
                        </div>
                        <div class="upload-label" id="uploadLabel"><strong>Click to upload</strong> or drag and drop<br>PDF, Markdown, or plain text</div>
                        <div class="file-name" id="fileName" style="display:none"></div>
                    </div>
                    <div class="upload-privacy">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        Privacy guaranteed
                    </div>
                </div>

                <!-- Job Description Card -->
                <div class="card">
                    <h2>Paste the Job Description</h2>
                    <textarea id="jobDescription" placeholder="Paste the full job description here..."></textarea>
                    <div class="inline-error" id="jdError">Job description is too short. Please paste at least 50 characters.</div>
                    <div class="char-count"><span id="charCount">0</span> characters &middot; <span id="wordCount">0</span> words</div>
                </div>
            </div>

            <!-- Controls Row -->
            <div class="controls-row">
                <div class="toggle-group">
                    <input type="radio" name="mode" id="modeC" value="conservative" checked>
                    <label for="modeC">Conservative</label>
                    <input type="radio" name="mode" id="modeA" value="aggressive">
                    <label for="modeA">Aggressive</label>
                </div>
                <div class="toggle-group">
                    <input type="radio" name="template" id="tplExec" value="executive">
                    <label for="tplExec">Executive</label>
                    <input type="radio" name="template" id="tplModern" value="modern" checked>
                    <label for="tplModern">Modern</label>
                    <input type="radio" name="template" id="tplMin" value="minimal">
                    <label for="tplMin">Minimal</label>
                </div>
            </div>

            <!-- Model Selector (shown only when admin enables it) -->
            <div id="modelSection" style="display:none; margin-bottom: 20px;">
                <label style="font-size:13px; font-weight:600; color:var(--text-secondary); display:block; margin-bottom:6px;">AI Model</label>
                <select id="modelSelect" onchange="selectedModel=this.value; saveModelPref();"
                    style="width:100%; max-width:360px; padding:10px 14px; border:1px solid var(--border);
                           border-radius:8px; font-size:14px; font-family:inherit; outline:none; background:white;
                           cursor:pointer; color:var(--text);">
                </select>
            </div>

            <!-- CTA -->
            <div class="cta-row">
                <button class="btn-run" id="btnRun" onclick="startTailoring()">Tailor My Resume</button>
                <div class="cta-hint" id="ctaHint">Takes about 2 minutes &middot; Sign in to save your results</div>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="progress-section" id="progressSection">
            <div class="card">
                <div class="progress-wrap">
                    <div class="progress-current-stage" id="progressStageText">Analyzing your resume...</div>
                    <div class="progress-bar-track">
                        <div class="progress-bar-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-pct" id="progressPct">0%</div>
                    <div class="elapsed-time" id="elapsedTime" style="display:none;">Processing... <span id="elapsedValue">0:00</span></div>
                    <div class="reconnecting-badge" id="reconnectingBadge"><span class="dot"></span> Reconnecting...</div>
                    <div class="time-estimate" id="timeEstimate">Usually takes 2-3 minutes</div>
                    <div class="tip-container" id="tipContainer">
                        <div class="tip-text" id="tipText">75% of resumes are rejected by ATS systems before a human sees them</div>
                    </div>
                    <div class="stage-list" id="stageList"></div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <!-- Score -->
            <div class="card">
                <div class="score-section">
                    <div class="score-ring-wrap">
                        <svg viewBox="0 0 140 140">
                            <circle class="score-ring-bg" cx="70" cy="70" r="60"/>
                            <circle class="score-ring-fill" id="scoreRing" cx="70" cy="70" r="60" stroke-dasharray="376.99" stroke-dashoffset="376.99"/>
                        </svg>
                        <div class="score-ring-value" id="matchScore">--</div>
                    </div>
                    <div class="score-ring-label">Match Score</div>
                    <div class="score-stats">
                        <span>Keyword Match: <strong id="keywordMatch">--</strong></span>
                        <span><strong id="keywordsAdded">--</strong> keywords added</span>
                    </div>
                </div>
                <div class="keywords-section" id="kwSection" style="display:none">
                    <div class="keywords-section-label">Keywords</div>
                    <div class="keywords" id="kwList"></div>
                </div>
            </div>

            <!-- Downloads -->
            <div class="card">
                <div class="downloads-heading">Your Tailored Resumes</div>

                <div class="dl-cards" id="dlCards">
                    <div class="dl-card" id="dlCardAts">
                        <div class="dl-card-icon ats">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                        </div>
                        <div class="dl-card-title">ATS Resume</div>
                        <div class="dl-card-desc">Optimized for automated screening systems</div>
                        <span class="dl-card-btn" id="dlBtnAts">Download PDF</span>
                    </div>
                    <div class="dl-card rec-card" id="dlCardRec">
                        <div class="dl-card-icon rec">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                        </div>
                        <div class="dl-card-title">Recruiter Resume</div>
                        <div class="dl-card-desc">Enhanced for human readability</div>
                        <span class="dl-card-btn" id="dlBtnRec">Download PDF</span>
                    </div>
                </div>

                <div class="dl-usage-hint">Use the ATS version for online applications. Use the Recruiter version when emailing directly.</div>

                <button class="additional-toggle" id="additionalToggle" onclick="toggleAdditional()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
                    Additional files
                </button>
                <div class="additional-files" id="additionalFiles">
                    <div class="additional-files-grid" id="dlGridSecondary"></div>
                </div>
            </div>

            <!-- Talking Points -->
            <div class="card talking-points-card" id="talkingPointsCard" style="display:none">
                <h2>Interview Talking Points</h2>
                <div class="talking-points-content" id="talkingPointsContent"></div>
            </div>

            <!-- Preview -->
            <div class="card">
                <div class="preview-header">
                    <h2 style="margin-bottom:0">Resume Preview</h2>
                    <button class="copy-btn" onclick="copyPreview()">Copy</button>
                </div>
                <div class="tabs" id="tabs"></div>
                <div id="panels"></div>
            </div>

            <div class="again-wrap">
                <button class="btn-again" onclick="resetForm()">Tailor Another Resume</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="footer-brand">CVtailro &middot; AI-powered resume optimization</div>
        <div class="footer-links">
            <a href="#">Privacy</a>
            <a href="#">Terms</a>
            <a href="#">Contact</a>
        </div>
        <div class="footer-copy">&copy; 2026 CVtailro. All rights reserved.</div>
    </footer>

    <!-- History Overlay -->
    <div class="history-overlay" id="historyOverlay" onclick="if(event.target===this)closeHistory()">
        <div class="history-panel">
            <div class="history-header">
                <h2>Tailoring History</h2>
                <button class="history-close" onclick="closeHistory()" aria-label="Close history">&times;</button>
            </div>
            <div class="history-body" id="historyBody">
                <div class="history-loading">Loading your history...</div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast" id="toastNotification" role="alert"></div>

    <script>
    // --- Stage Names: internal key -> user-friendly label ---
    var STAGES = [
        "Job Intelligence",
        "Resume Parser",
        "Gap Analysis",
        "Bullet Optimiser",
        "ATS Optimiser",
        "Recruiter Optimiser",
        "Final Assembly"
    ];
    var STAGE_LABELS = {
        "Job Intelligence": "Understanding the job requirements",
        "Resume Parser": "Analyzing your resume",
        "Gap Analysis": "Identifying skill gaps",
        "Bullet Optimiser": "Rewriting your bullet points",
        "ATS Optimiser": "Building your ATS-optimized resume",
        "Recruiter Optimiser": "Enhancing for recruiter appeal",
        "Final Assembly": "Generating interview prep & final documents"
    };

    // --- Tips rotation ---
    var TIPS = [
        "75% of resumes are rejected by ATS systems before a human sees them",
        "Tailoring your resume for each application can increase interview callbacks by 50%",
        "Our AI rewrites your bullet points using the exact language from the job description",
        "We generate both an ATS-optimized version and a recruiter-friendly version",
        "Your original resume content is never fabricated -- only reframed and enhanced",
        "We also prepare interview talking points based on your tailored resume"
    ];
    var tipIndex = 0;
    var tipInterval = null;

    function startTipRotation() {
        tipIndex = 0;
        var tipEl = document.getElementById('tipText');
        if (tipEl) tipEl.textContent = TIPS[0];
        tipInterval = setInterval(function() {
            tipIndex = (tipIndex + 1) % TIPS.length;
            var el = document.getElementById('tipText');
            if (el) {
                el.style.opacity = '0';
                setTimeout(function() {
                    el.textContent = TIPS[tipIndex];
                    el.style.opacity = '1';
                }, 400);
            }
        }, 8000);
    }

    function stopTipRotation() {
        if (tipInterval) { clearInterval(tipInterval); tipInterval = null; }
    }

    // --- Settings Management ---
    var serviceConfigured = false;
    var userSelectable = false;
    var selectedModel = '';

    async function loadSettings() {
        try {
            var statusResp = await fetch('/api/status');
            var statusData = await statusResp.json();
            serviceConfigured = statusData.configured;
            if (!serviceConfigured) {
                document.getElementById('configBanner').style.display = 'block';
                document.getElementById('btnRun').disabled = true;
            } else {
                document.getElementById('configBanner').style.display = 'none';
            }
        } catch(e) {
            document.getElementById('configBanner').style.display = 'block';
        }

        try {
            var modelsResp = await fetch('/api/models');
            var data = await modelsResp.json();
            userSelectable = data.user_selectable !== false;
            selectedModel = localStorage.getItem('cvtailro_model') || data.default || '';
            if (data.models && data.models.length > 0) {
                var validIds = data.models.map(function(m) { return m.id; });
                if (selectedModel && validIds.indexOf(selectedModel) === -1) {
                    selectedModel = data.default || '';
                }
            }
            // Show model selector if admin allows it
            if (userSelectable && data.models && data.models.length > 0) {
                var select = document.getElementById('modelSelect');
                var free = data.models.filter(function(m) { return m.name.indexOf('(Free)') !== -1; });
                var paid = data.models.filter(function(m) { return m.name.indexOf('(Free)') === -1; });
                var html = '';
                if (free.length > 0) {
                    html += '<optgroup label="Free">';
                    free.forEach(function(m) {
                        html += '<option value="' + m.id + '"' + (m.id === selectedModel ? ' selected' : '') + '>' + m.name.replace(' (Free)', '') + '</option>';
                    });
                    html += '</optgroup>';
                }
                if (paid.length > 0) {
                    html += '<optgroup label="Premium">';
                    paid.forEach(function(m) {
                        html += '<option value="' + m.id + '"' + (m.id === selectedModel ? ' selected' : '') + '>' + m.name + '</option>';
                    });
                    html += '</optgroup>';
                }
                select.innerHTML = html;
                document.getElementById('modelSection').style.display = 'block';
            }
        } catch(e) {
            console.error('Failed to load models:', e);
        }
    }

    function saveModelPref() {
        localStorage.setItem('cvtailro_model', selectedModel);
    }

    function getSelectedModel() {
        if (!userSelectable) return '';
        return selectedModel;
    }

    loadSettings();

    // --- Auth State ---
    var authUser = null; // null = not checked yet, false = not logged in, object = logged in

    async function checkAuth() {
        try {
            var resp = await fetch('/auth/me', { credentials: 'same-origin' });
            if (resp.ok) {
                var data = await resp.json();
                if (data && data.authenticated && data.email) {
                    authUser = data;
                    renderAuthUI();
                    return;
                }
            }
            // {authenticated: false}, 401, 404, or unexpected response
            authUser = false;
            renderAuthUI();
        } catch(e) {
            // Auth endpoint not deployed yet, network error, or 500 â€” show sign-in button
            authUser = false;
            renderAuthUI();
        }
    }

    function renderAuthUI() {
        var signinBtn = document.getElementById('btnGoogleSignin');
        var userMenuWrap = document.getElementById('userMenuWrap');
        var ctaHint = document.getElementById('ctaHint');

        if (authUser && authUser.email) {
            // Logged in
            signinBtn.style.display = 'none';
            userMenuWrap.style.display = 'block';

            // Set avatar
            var avatarEl = document.getElementById('userAvatar');
            if (authUser.picture) {
                avatarEl.innerHTML = '<img src="' + escapeAttr(authUser.picture) + '" alt="Avatar" referrerpolicy="no-referrer">';
            } else {
                var initials = (authUser.name || authUser.email || '?').charAt(0).toUpperCase();
                avatarEl.textContent = initials;
            }

            // Set name in trigger
            var nameText = document.getElementById('userNameText');
            nameText.textContent = (authUser.name || '').split(' ')[0] || '';

            // Set dropdown info
            document.getElementById('dropdownUserName').textContent = authUser.name || '';
            document.getElementById('dropdownUserEmail').textContent = authUser.email || '';

            // Show admin link if admin
            if (authUser.is_admin) {
                document.getElementById('adminLink').style.display = 'flex';
                document.getElementById('adminDivider').style.display = 'block';
            }

            // Update CTA hint for signed-in users
            if (ctaHint) {
                ctaHint.textContent = 'Takes about 2 minutes \u00b7 Results will be saved to your history';
            }
        } else {
            // Not logged in
            signinBtn.style.display = 'inline-flex';
            userMenuWrap.style.display = 'none';

            // Update CTA hint for signed-out users
            if (ctaHint) {
                ctaHint.textContent = 'Takes about 2 minutes \u00b7 Sign in with Google to get started';
            }
        }
    }

    function escapeAttr(s) {
        return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function toggleUserMenu(e) {
        e.stopPropagation();
        var wrap = document.getElementById('userMenuWrap');
        wrap.classList.toggle('open');
    }

    // Close user menu when clicking outside
    document.addEventListener('click', function(e) {
        var wrap = document.getElementById('userMenuWrap');
        if (wrap && !wrap.contains(e.target)) {
            wrap.classList.remove('open');
        }
    });

    async function signOut() {
        try {
            await fetch('/auth/logout', { method: 'POST', credentials: 'same-origin' });
        } catch(e) {
            // Even if the request fails, clear local state
        }
        authUser = false;
        document.getElementById('userMenuWrap').classList.remove('open');
        renderAuthUI();
        showToast('You have been signed out.', 'info');
    }

    // --- Toast Notifications ---
    var toastTimer = null;

    function showToast(message, type) {
        type = type || 'info';
        var toast = document.getElementById('toastNotification');
        toast.textContent = message;
        toast.className = 'toast toast-' + type;
        // Force reflow to restart animation
        void toast.offsetWidth;
        toast.classList.add('visible');
        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(function() {
            toast.classList.remove('visible');
        }, 5000);
    }

    // --- Auth error from URL params ---
    (function checkAuthError() {
        var params = new URLSearchParams(window.location.search);
        var authError = params.get('auth_error');
        if (authError) {
            var messages = {
                'access_denied': 'Sign-in was cancelled.',
                'no_email': 'Could not get your email from Google. Please try again.',
                'callback_failed': 'Sign-in failed. Please try again.',
                'unauthorized': 'Your account is not authorized. Please contact the administrator.'
            };
            showToast(messages[authError] || 'Sign-in error: ' + authError, 'error');
            // Clean URL
            var cleanUrl = window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
        }
    })();

    // Check auth on page load
    checkAuth();

    // --- Elapsed Timer ---
    var elapsedTimer = null;
    var elapsedStartTime = null;

    function startElapsedTimer() {
        elapsedStartTime = Date.now();
        var el = document.getElementById('elapsedTime');
        var valEl = document.getElementById('elapsedValue');
        el.style.display = 'block';
        elapsedTimer = setInterval(function() {
            var elapsed = Math.floor((Date.now() - elapsedStartTime) / 1000);
            var mins = Math.floor(elapsed / 60);
            var secs = elapsed % 60;
            valEl.textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;
        }, 1000);
    }

    function stopElapsedTimer() {
        if (elapsedTimer) { clearInterval(elapsedTimer); elapsedTimer = null; }
        var el = document.getElementById('elapsedTime');
        if (el) el.style.display = 'none';
    }

    // --- History ---
    function showHistory() {
        document.getElementById('userMenuWrap').classList.remove('open');
        var overlay = document.getElementById('historyOverlay');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
        loadHistory();
    }

    function closeHistory() {
        document.getElementById('historyOverlay').classList.remove('active');
        document.body.style.overflow = '';
    }

    // Close history on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            var overlay = document.getElementById('historyOverlay');
            if (overlay.classList.contains('active')) {
                closeHistory();
            }
        }
    });

    async function loadHistory() {
        var body = document.getElementById('historyBody');
        body.innerHTML = '<div class="history-loading">Loading your history...</div>';
        try {
            var resp = await fetch('/api/history', { credentials: 'same-origin' });
            if (!resp.ok) {
                if (resp.status === 401) {
                    body.innerHTML = '<div class="history-empty"><p>Please sign in to view your history.</p></div>';
                    return;
                }
                throw new Error('Failed to load history');
            }
            var data = await resp.json();
            var jobs = data.jobs || data || [];
            if (!jobs.length) {
                body.innerHTML =
                    '<div class="history-empty">' +
                        '<div class="history-empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>' +
                        '<h3>No tailoring jobs yet</h3>' +
                        '<p>Your tailoring history will appear here after your first job.</p>' +
                    '</div>';
                return;
            }
            var html = '';
            jobs.forEach(function(job) {
                var score = job.match_score || 0;
                var scoreClass = score >= 80 ? 'high' : score >= 50 ? 'mid' : 'low';
                var title = job.job_title || job.company || 'Untitled Job';
                var company = job.company ? ' at ' + escapeHtml(job.company) : '';
                var date = job.created_at ? formatDate(job.created_at) : '';
                var model = (job.model_used || job.model || '');
                model = model ? model.split('/').pop() : '';
                html += '<div class="history-card" onclick="loadHistoryJob(\'' + escapeAttr(job.id || job.job_id) + '\')">' +
                    '<div class="history-card-score ' + scoreClass + '">' + Math.round(score) + '%</div>' +
                    '<div class="history-card-info">' +
                        '<div class="history-card-title">' + escapeHtml(title) + escapeHtml(company) + '</div>' +
                        '<div class="history-card-meta">' +
                            (date ? '<span>' + escapeHtml(date) + '</span>' : '') +
                            (model ? '<span>' + escapeHtml(model) + '</span>' : '') +
                        '</div>' +
                    '</div>' +
                    '<svg class="history-card-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>' +
                '</div>';
            });
            body.innerHTML = html;
        } catch(e) {
            body.innerHTML = '<div class="history-empty"><p>Could not load history. Please try again.</p></div>';
        }
    }

    function formatDate(dateStr) {
        try {
            var d = new Date(dateStr);
            var now = new Date();
            var diff = now - d;
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
            return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: d.getFullYear() !== now.getFullYear() ? 'numeric' : undefined });
        } catch(e) {
            return dateStr;
        }
    }

    async function loadHistoryJob(jobId) {
        closeHistory();
        // Show progress section while loading
        document.getElementById('formSection').style.display = 'none';
        document.getElementById('progressSection').classList.remove('active');
        document.getElementById('resultsSection').classList.remove('active');

        try {
            var resp = await fetch('/api/history/' + jobId, { credentials: 'same-origin' });
            if (!resp.ok) throw new Error('Failed to load job');
            var data = await resp.json();
            // The history endpoint should return the same format as /api/result
            renderResultsFromData(data, jobId);
        } catch(e) {
            showError('Could not load this job. It may have expired.');
            document.getElementById('formSection').style.display = '';
        }
    }

    function renderResultsFromData(data, jobId) {
        // data should contain the result object (same shape as /api/result response)
        var s = data.result || data;

        try {
            // Reset UI state
            document.getElementById('formSection').style.display = 'none';
            document.getElementById('progressSection').classList.remove('active');

            // --- Circular Score ---
            var scoreVal = (s.match_score || 0).toFixed(0);
            var scoreNum = parseFloat(scoreVal);
            document.getElementById("matchScore").textContent = scoreVal + "%";

            var circumference = 2 * Math.PI * 60;
            var offset = circumference - (scoreNum / 100) * circumference;
            var ring = document.getElementById("scoreRing");
            ring.style.strokeDasharray = circumference;
            var scoreColor = scoreNum >= 80 ? 'var(--score-high)' : scoreNum >= 50 ? 'var(--score-mid)' : 'var(--score-low)';
            ring.style.stroke = scoreColor;
            setTimeout(function() { ring.style.strokeDashoffset = offset; }, 100);

            // Keyword Match
            var kwMatchPct = Math.round((s.cosine_similarity || 0) * 100);
            document.getElementById("keywordMatch").textContent = kwMatchPct + "%";

            // Keywords Added
            var keywordsAddedCount = typeof s.matched_keywords_count === 'number' ? s.matched_keywords_count : Math.max(1, Math.round((s.match_score || 0) * 0.3));
            document.getElementById("keywordsAdded").textContent = keywordsAddedCount;

            // Keywords chips
            if (s.missing_keywords && s.missing_keywords.length > 0) {
                document.getElementById("kwSection").style.display = "block";
                document.getElementById("kwList").innerHTML = s.missing_keywords.map(function(k) {
                    return '<span class="kw kw-missing">' + escapeHtml(k) + '</span>';
                }).join("");
            } else {
                document.getElementById("kwSection").style.display = "none";
            }

            // --- Downloads ---
            var atsLink = '', recLink = '', atsFname = '', recFname = '', secondaryHtml = '';
            var effectiveJobId = jobId || s.job_id || s.id || '';

            // Always generate standard download links (DB fallback regenerates PDFs/DOCX)
            var fileList = (s.files && s.files.length > 0) ? s.files : [
                "tailored_resume_ats.pdf", "tailored_resume_recruiter.pdf",
                "tailored_resume_ats.docx", "tailored_resume_recruiter.docx",
                "tailored_resume_ats.md", "tailored_resume_recruiter.md",
                "match_report.json", "interview_talking_points.md"
            ];
            if (effectiveJobId) {
                fileList.forEach(function(f) {
                    var fname = typeof f === 'string' ? f : f.filename;
                    var m = FILES[fname] || {l: fname, b: "", cat: "other", primary: false};
                    var link = '/api/download/' + effectiveJobId + '/' + fname;
                    if (m.primary) {
                        if (m.cat === 'ats') { atsLink = link; atsFname = fname; }
                        else if (m.cat === 'rec') { recLink = link; recFname = fname; }
                    } else {
                        secondaryHtml += '<a class="dl-btn-secondary" href="#" onclick="safeDownload(\'' + link + '\',\'' + fname + '\',event); return false;"><span class="label">' + escapeHtml(m.l) + '</span><span class="badge">' + m.b + '</span></a>';
                    }
                });
            }

            // Reset download cards with click handlers that use safeDownload
            var dlCards = document.getElementById("dlCards");
            dlCards.innerHTML =
                '<div class="dl-card" id="dlCardAts" style="cursor:pointer" onclick="' + (atsLink ? 'safeDownload(\'' + atsLink + '\',\'' + atsFname + '\',event)' : '') + '"><div class="dl-card-icon ats"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></div><div class="dl-card-title">ATS Resume</div><div class="dl-card-desc">Optimized for automated screening systems</div><span class="dl-card-btn" id="dlBtnAts">Download PDF</span></div>' +
                '<div class="dl-card rec-card" id="dlCardRec" style="cursor:pointer" onclick="' + (recLink ? 'safeDownload(\'' + recLink + '\',\'' + recFname + '\',event)' : '') + '"><div class="dl-card-icon rec"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg></div><div class="dl-card-title">Recruiter Resume</div><div class="dl-card-desc">Enhanced for human readability</div><span class="dl-card-btn" id="dlBtnRec">Download PDF</span></div>';

            document.getElementById("dlGridSecondary").innerHTML = secondaryHtml;

            // --- Talking Points ---
            if (s.talking_points_md) {
                document.getElementById("talkingPointsCard").style.display = "block";
                document.getElementById("talkingPointsContent").innerHTML = renderMarkdown(s.talking_points_md);
            } else {
                document.getElementById("talkingPointsCard").style.display = "none";
            }

            // --- Preview tabs ---
            var previews = [
                {id: "ats", l: "ATS Resume", c: s.ats_resume_md},
                {id: "rec", l: "Recruiter Resume", c: s.recruiter_resume_md},
                {id: "changes", l: "What Changed", c: null}
            ];
            document.getElementById("tabs").innerHTML = previews.map(function(p, i) {
                return '<button class="tab ' + (i === 0 ? 'active' : '') + '" onclick="switchTab(\'' + p.id + '\',this)">' + p.l + '</button>';
            }).join("");
            document.getElementById("panels").innerHTML = previews.map(function(p, i) {
                var content = p.id === 'changes' ? buildChangesPanel(s) : renderMarkdown(p.c);
                return '<div class="tab-content ' + (i === 0 ? 'active' : '') + '" id="pnl-' + p.id + '">' + content + '</div>';
            }).join("");

            document.getElementById("resultsSection").classList.add("active");
            document.getElementById("resultsSection").scrollIntoView({behavior: "smooth"});
        } catch(renderErr) {
            console.error("Failed to render history results:", renderErr);
            showError("Results loaded but failed to display.");
            document.getElementById('formSection').style.display = '';
        }
    }

    // --- Friendly Error Messages ---
    function friendlyErrorMessage(rawMsg, modelName) {
        if (!rawMsg) return 'An unexpected error occurred. Please try again.';
        var msg = String(rawMsg);

        // High demand / queue
        if (msg.match(/high demand/i) || msg.match(/queue/i)) {
            return 'The system is busy. Please wait and try again.';
        }

        // Rate limiting
        if (msg.match(/rate.?limit/i) || msg.match(/429/i) || msg.match(/too many requests/i)) {
            return "The system is handling a lot of requests. Please wait a moment and try again.";
        }

        // System at capacity
        if (msg.match(/503/i)) {
            return 'System at capacity. Please try again in a minute.';
        }

        // Invalid API key / auth errors
        if (msg.match(/invalid.*api.?key/i) || msg.match(/401/i) || msg.match(/unauthorized/i) || msg.match(/authentication/i)) {
            return 'Service configuration error. Please contact the administrator.';
        }

        // Timeout
        if (msg.match(/timeout/i) || msg.match(/timed?\s*out/i)) {
            return 'The AI model took too long to respond. Please try again' + (modelName ? ' or try a different model.' : '.');
        }

        // Context length / token limit
        if (msg.match(/context.*length/i) || msg.match(/too.*long/i) || msg.match(/token/i)) {
            return 'Your resume or job description is too long for this model. Try shortening it or using a different model.';
        }

        // Model unavailable
        if (msg.match(/model.*not.*found/i) || msg.match(/model.*unavailable/i) || msg.match(/no.*endpoints/i)) {
            return 'The selected AI model is temporarily unavailable. Please try a different model.';
        }

        // Network / connection
        if (msg.match(/network/i) || msg.match(/fetch/i) || msg.match(/ECONNREFUSED/i) || msg.match(/connection/i)) {
            return 'Connection lost. Your resume is still being processed -- results will appear shortly.';
        }

        // Strip Python tracebacks: only show the last meaningful line
        if (msg.indexOf('Traceback') !== -1 || msg.indexOf('File "') !== -1) {
            var lines = msg.split('\n').filter(function(l) { return l.trim() && !l.match(/^\s*(File|Traceback|at )/); });
            var lastLine = lines.length > 0 ? lines[lines.length - 1].trim() : 'An unexpected error occurred.';
            return 'Processing error' + (modelName ? ' (' + modelName + ')' : '') + ': ' + lastLine;
        }

        // Default: clean up and show with model name
        if (modelName) {
            return 'Error with ' + modelName + ': ' + msg;
        }
        return msg;
    }

    var FILES = {
        "tailored_resume_ats.pdf":      {l:"ATS Resume",       b:"PDF",  cat:"ats",    primary:true},
        "tailored_resume_recruiter.pdf": {l:"Recruiter Resume", b:"PDF",  cat:"rec",    primary:true},
        "tailored_resume_ats.docx":      {l:"ATS Resume",       b:"DOCX", cat:"ats",    primary:false},
        "tailored_resume_recruiter.docx":{l:"Recruiter Resume", b:"DOCX", cat:"rec",    primary:false},
        "tailored_resume_ats.md":        {l:"ATS Resume",       b:"MD",   cat:"ats",    primary:false},
        "tailored_resume_recruiter.md":  {l:"Recruiter Resume", b:"MD",   cat:"rec",    primary:false},
        "match_report.json":             {l:"Match Report",     b:"JSON", cat:"other",  primary:false},
        "interview_talking_points.md":   {l:"Talking Points",   b:"MD",   cat:"other",  primary:false}
    };

    // --- Mobile detection for upload label ---
    function isTouchDevice() {
        return ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
    }
    (function setUploadLabel() {
        var label = document.getElementById('uploadLabel');
        if (isTouchDevice()) {
            label.innerHTML = '<strong>Tap to upload</strong><br>PDF, Markdown, or plain text';
        } else {
            label.innerHTML = '<strong>Click to upload</strong> or drag and drop<br>PDF, Markdown, or plain text';
        }
    })();

    // File upload
    var uploadZone = document.getElementById("uploadZone");
    var fileInput = document.getElementById("resumeFile");
    var fileNameEl = document.getElementById("fileName");
    fileInput.addEventListener("change", function() {
        if (fileInput.files.length > 0) {
            uploadZone.classList.add("has-file");
            fileNameEl.textContent = fileInput.files[0].name;
            fileNameEl.style.display = "block";
        }
    });
    uploadZone.addEventListener("dragover", function(e) { e.preventDefault(); uploadZone.classList.add("dragover"); });
    uploadZone.addEventListener("dragleave", function() { uploadZone.classList.remove("dragover"); });
    uploadZone.addEventListener("drop", function(e) {
        e.preventDefault();
        uploadZone.classList.remove("dragover");
        if (e.dataTransfer.files.length > 0) {
            fileInput.files = e.dataTransfer.files;
            fileInput.dispatchEvent(new Event("change"));
        }
    });

    // Char count
    var jdTA = document.getElementById("jobDescription");
    jdTA.addEventListener("input", function() {
        document.getElementById("charCount").textContent = jdTA.value.length;
        document.getElementById("wordCount").textContent = jdTA.value.split(/\s+/).filter(function(w) { return w; }).length;
        if (jdTA.value.trim().length >= 50) {
            jdTA.classList.remove('input-error');
            document.getElementById('jdError').classList.remove('visible');
        }
    });

    // Keyboard shortcut
    document.addEventListener("keydown", function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter" && !document.getElementById("btnRun").disabled) startTailoring();
    });

    function showError(msg) {
        var b = document.getElementById("errorBanner");
        document.getElementById("errorMsg").textContent = msg;
        b.classList.add("active");
    }

    function dismissError() {
        document.getElementById("errorBanner").classList.remove("active");
    }

    // --- Safe download via fetch (shows errors as toast instead of navigating away) ---
    async function safeDownload(url, filename, event) {
        if (event) event.preventDefault();
        try {
            var resp = await fetch(url, { credentials: 'same-origin' });
            if (!resp.ok) {
                var errData;
                try { errData = await resp.json(); } catch(e) { errData = {}; }
                var errMsg = errData.error || ('Download failed (HTTP ' + resp.status + ')');
                showError(errMsg);
                return;
            }
            var blob = await resp.blob();
            var blobUrl = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = blobUrl;
            a.download = filename || url.split('/').pop();
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(function() { URL.revokeObjectURL(blobUrl); }, 1000);
        } catch(e) {
            showError('Download failed: ' + e.message);
        }
    }

    // --- Simple markdown to HTML renderer ---
    function renderMarkdown(text) {
        if (!text) return '';
        var html = escapeHtml(text);

        // Headings: ### then ##
        html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
        html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');

        // Bold: **text**
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

        // Italic: *text*
        html = html.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>');

        // Unordered list items: lines starting with - or *
        html = html.replace(/^[-*] (.+)$/gm, '<li>$1</li>');

        // Wrap consecutive <li> in <ul>
        html = html.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');

        // Paragraphs: wrap remaining non-tag text lines
        html = html.split('\n').map(function(line) {
            line = line.trim();
            if (!line) return '';
            if (line.startsWith('<h') || line.startsWith('<ul') || line.startsWith('<li') || line.startsWith('</')) return line;
            return '<p>' + line + '</p>';
        }).join('\n');

        // Clean up empty <p></p>
        html = html.replace(/<p>\s*<\/p>/g, '');

        return html;
    }

    function escapeHtml(t) {
        var d = document.createElement("div");
        d.textContent = t;
        return d.innerHTML;
    }

    function renderStages() {
        document.getElementById("stageList").innerHTML = STAGES.map(function(n, i) {
            var label = STAGE_LABELS[n] || n;
            return '<div class="stage" id="stage-row-' + (i+1) + '">' +
                '<div class="stage-check pending" id="ind-' + (i+1) + '">' +
                    '<svg width="18" height="18" viewBox="0 0 18 18" fill="none"><circle cx="9" cy="9" r="7" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>' +
                '</div>' +
                '<div class="stage-name">' + label + '</div>' +
                '<div class="stage-detail" id="det-' + (i+1) + '" style="display:none"></div>' +
            '</div>';
        }).join("");
    }

    // --- Smooth progress ---
    var targetProgress = 0;
    var currentProgress = 0;
    var progressAnimFrame = null;

    function setTargetProgress(pct) {
        targetProgress = pct;
        if (!progressAnimFrame) animateProgress();
    }

    function animateProgress() {
        if (currentProgress < targetProgress) {
            currentProgress = Math.min(currentProgress + 0.5, targetProgress);
            document.getElementById("progressFill").style.width = currentProgress + "%";
            document.getElementById("progressPct").textContent = Math.round(currentProgress) + "%";
            progressAnimFrame = requestAnimationFrame(animateProgress);
        } else {
            progressAnimFrame = null;
        }
    }

    function updateProgress() {
        var done = document.querySelectorAll(".stage-check.done").length;
        var running = document.querySelectorAll(".stage-check.running").length;
        var pct = Math.round(done / STAGES.length * 100);
        setTargetProgress(pct);

        // Update current stage text
        var stageText = document.getElementById("progressStageText");
        if (done === STAGES.length) {
            stageText.textContent = "Finishing up...";
        } else {
            // Find the running stage
            for (var i = 0; i < STAGES.length; i++) {
                var ind = document.getElementById('ind-' + (i+1));
                if (ind && ind.classList.contains('running')) {
                    stageText.textContent = (STAGE_LABELS[STAGES[i]] || STAGES[i]) + '...';
                    break;
                }
            }
        }
    }

    async function startTailoring() {
        // Require sign-in
        if (!authUser || authUser === false) {
            showToast('Please sign in with Google to use this tool', 'info');
            setTimeout(function() { window.location.href = '/auth/google/login'; }, 1500);
            return;
        }
        if (!serviceConfigured) { showError("Service is temporarily unavailable. Please try again later."); return; }
        var file = fileInput.files[0], jd = jdTA.value.trim();
        var mode = document.querySelector('input[name="mode"]:checked').value;
        var template = document.querySelector('input[name="template"]:checked').value;
        var model = getSelectedModel();

        if (!file) { showError("Please upload your resume first."); return; }
        if (!jd || jd.length < 50) {
            jdTA.classList.add('input-error');
            document.getElementById('jdError').classList.add('visible');
            showError("Job description is too short (minimum 50 characters).");
            jdTA.focus();
            return;
        }

        // Reset progress state
        targetProgress = 0;
        currentProgress = 0;
        if (progressAnimFrame) { cancelAnimationFrame(progressAnimFrame); progressAnimFrame = null; }

        var btn = document.getElementById("btnRun");
        btn.disabled = true;
        btn.textContent = "Processing...";
        document.getElementById("progressSection").classList.add("active");
        document.getElementById("resultsSection").classList.remove("active");
        document.getElementById("progressStageText").textContent = "Analyzing your resume...";
        renderStages();
        document.getElementById("progressFill").style.width = "0%";
        document.getElementById("progressPct").textContent = "0%";
        startTipRotation();
        startElapsedTimer();
        document.getElementById('reconnectingBadge').classList.remove('visible');

        var fd = new FormData();
        fd.append("resume", file);
        fd.append("job_description", jd);
        fd.append("mode", mode);
        fd.append("template", template);
        if (model) fd.append("model", model);

        try {
            var r = await fetch("/api/tailor", {method: "POST", body: fd});
            var d = await r.json();
            if (r.status === 503) {
                showError("The system is handling a lot of requests right now. Please wait 30 seconds and try again.");
                btn.disabled = false; btn.textContent = "Tailor My Resume";
                stopTipRotation(); stopElapsedTimer();
                return;
            }
            if (r.status === 429) {
                showError(d.error || "You've reached your limit for this demo session.");
                btn.disabled = false; btn.textContent = "Tailor My Resume";
                stopTipRotation(); stopElapsedTimer();
                return;
            }
            if (!r.ok) {
                showError(friendlyErrorMessage(d.error || "Failed to start", model));
                btn.disabled = false; btn.textContent = "Tailor My Resume";
                stopTipRotation();
                stopElapsedTimer();
                return;
            }
            var jobId = d.job_id;

            var sseRetries = 0;
            var maxSseRetries = 5;
            var finished = false;

            function handleStageUpdate(m) {
                if (m.stage) {
                    var ind = document.getElementById('ind-' + m.stage);
                    var det = document.getElementById('det-' + m.stage);
                    var row = document.getElementById('stage-row-' + m.stage);
                    if (ind) {
                        ind.className = "stage-check " + m.status;
                        if (m.status === "done") {
                            ind.innerHTML = '<svg width="18" height="18" viewBox="0 0 18 18" fill="none"><circle cx="9" cy="9" r="8" fill="currentColor" opacity="0.15"/><path d="M6 9.5l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                        } else if (m.status === "running") {
                            ind.innerHTML = '<svg width="18" height="18" viewBox="0 0 18 18" fill="none"><circle cx="9" cy="9" r="7" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="10 5"><animateTransform attributeName="transform" type="rotate" from="0 9 9" to="360 9 9" dur="1s" repeatCount="indefinite"/></circle></svg>';
                        } else if (m.status === "error") {
                            ind.innerHTML = '<svg width="18" height="18" viewBox="0 0 18 18" fill="none"><circle cx="9" cy="9" r="8" fill="currentColor" opacity="0.15"/><path d="M6.5 6.5l5 5M11.5 6.5l-5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
                        }
                    }
                    if (row) {
                        row.className = 'stage';
                        if (m.status === 'done') row.classList.add('is-done');
                        else if (m.status === 'running') row.classList.add('is-running');
                    }
                    if (det) det.textContent = m.detail || "";
                    updateProgress();
                }
            }

            function onComplete(jid) {
                if (finished) return;
                finished = true;
                stopTipRotation();
                stopElapsedTimer();
                document.getElementById('reconnectingBadge').classList.remove('visible');
                loadResults(jid);
                btn.disabled = false; btn.textContent = "Tailor My Resume";
                if (authUser && authUser.email) {
                    showToast('Results saved to your history', 'success');
                }
            }

            function onError(msg) {
                if (finished) return;
                finished = true;
                stopTipRotation();
                stopElapsedTimer();
                document.getElementById('reconnectingBadge').classList.remove('visible');
                showError(friendlyErrorMessage(msg, model));
                btn.disabled = false; btn.textContent = "Tailor My Resume";
            }

            function connectSSE() {
                if (finished) return;
                var es = new EventSource('/api/progress/' + jobId);
                es.onmessage = function(ev) {
                    sseRetries = 0; // reset on successful message
                    document.getElementById('reconnectingBadge').classList.remove('visible');
                    var m = JSON.parse(ev.data);
                    if (m.status === "complete") { es.close(); onComplete(jobId); return; }
                    if (m.status === "error") { es.close(); onError(m.detail); return; }
                    if (m.status === "keepalive") return;
                    if (m.status === "queued") {
                        var pos = m.position || '';
                        var stageText = document.getElementById("progressStageText");
                        if (stageText) {
                            stageText.textContent = pos ? "You're #" + pos + " in the queue â€” hang tight!" : "In the queue â€” we'll start shortly...";
                        }
                        return;
                    }
                    handleStageUpdate(m);
                };
                es.onerror = function() {
                    es.close();
                    if (finished) return;
                    sseRetries++;
                    if (sseRetries <= maxSseRetries) {
                        // Show subtle reconnecting indicator
                        document.getElementById('reconnectingBadge').classList.add('visible');
                        setTimeout(connectSSE, 2000);
                    } else {
                        // Fall back to polling after exhausting SSE retries
                        document.getElementById('reconnectingBadge').classList.remove('visible');
                        pollForResult(jobId);
                    }
                };
            }

            function pollForResult(jid) {
                var pollFailCount = 0;
                var poll = setInterval(async function() {
                    if (finished) { clearInterval(poll); return; }
                    try {
                        var r = await fetch('/api/result/' + jid);
                        var d = await r.json();
                        pollFailCount = 0;
                        if (d.status === "complete") { clearInterval(poll); onComplete(jid); }
                        else if (d.status === "error") { clearInterval(poll); onError(d.error); }
                    } catch(e) {
                        pollFailCount++;
                        if (pollFailCount >= 10) {
                            clearInterval(poll);
                            onError('Connection lost. Please refresh the page and check your history for results.');
                        }
                    }
                }, 3000);
            }

            connectSSE();
        } catch(e) {
            showError(friendlyErrorMessage(e.message));
            btn.disabled = false; btn.textContent = "Tailor My Resume";
            stopTipRotation();
            stopElapsedTimer();
        }
    }

    async function loadResults(jobId, retryCount) {
        retryCount = retryCount || 0;
        try {
            var r = await fetch('/api/result/' + jobId);
            var d = await r.json();
            if (d.status !== "complete") {
                // Job not complete yet â€” retry a few times
                if (retryCount < 5) {
                    setTimeout(function() { loadResults(jobId, retryCount + 1); }, 2000);
                } else {
                    showError("Results could not be loaded. Please try again.");
                }
                return;
            }
            if (!d.result) {
                showError("Pipeline completed but produced no results. Check the admin error log.");
                return;
            }
        } catch(e) {
            if (retryCount < 3) {
                setTimeout(function() { loadResults(jobId, retryCount + 1); }, 2000);
            } else {
                showError("Failed to load results: " + e.message);
            }
            return;
        }
        var s = d.result;
        try {
        // --- Circular Score ---
        var scoreVal = s.match_score.toFixed(0);
        var scoreNum = parseFloat(scoreVal);
        document.getElementById("matchScore").textContent = scoreVal + "%";

        // Animate the ring
        var circumference = 2 * Math.PI * 60; // r=60
        var offset = circumference - (scoreNum / 100) * circumference;
        var ring = document.getElementById("scoreRing");
        ring.style.strokeDasharray = circumference;
        // Determine color
        var scoreColor = scoreNum >= 80 ? 'var(--score-high)' : scoreNum >= 50 ? 'var(--score-mid)' : 'var(--score-low)';
        ring.style.stroke = scoreColor;
        // Trigger animation after a short delay
        setTimeout(function() {
            ring.style.strokeDashoffset = offset;
        }, 100);

        // Keyword Match
        var kwMatchPct = Math.round(s.cosine_similarity * 100);
        document.getElementById("keywordMatch").textContent = kwMatchPct + "%";

        // Keywords Added
        var totalKeywords = (s.missing_keywords ? s.missing_keywords.length : 0);
        var keywordsAddedCount;
        if (typeof s.matched_keywords_count === 'number') {
            keywordsAddedCount = s.matched_keywords_count;
        } else {
            keywordsAddedCount = Math.max(1, Math.round(s.match_score * 0.3));
        }
        document.getElementById("keywordsAdded").textContent = keywordsAddedCount;

        // Keywords chips
        if (s.missing_keywords && s.missing_keywords.length > 0) {
            document.getElementById("kwSection").style.display = "block";
            document.getElementById("kwList").innerHTML = s.missing_keywords.map(function(k) {
                return '<span class="kw kw-missing">' + escapeHtml(k) + '</span>';
            }).join("");
        }

        // --- Downloads ---
        var atsLink = '';
        var recLink = '';
        var atsFname = '';
        var recFname = '';
        var secondaryHtml = '';

        // Use file list from result, or fallback to standard files (DB fallback has empty files[])
        var fileList = (s.files && s.files.length > 0) ? s.files : [
            "tailored_resume_ats.pdf", "tailored_resume_recruiter.pdf",
            "tailored_resume_ats.docx", "tailored_resume_recruiter.docx",
            "tailored_resume_ats.md", "tailored_resume_recruiter.md",
            "match_report.json", "interview_talking_points.md"
        ];
        fileList.forEach(function(f) {
            var fname = typeof f === 'string' ? f : f.filename;
            var m = FILES[fname] || {l: fname, b: "", cat: "other", primary: false};
            var link = '/api/download/' + jobId + '/' + fname;
            if (m.primary) {
                if (m.cat === 'ats') { atsLink = link; atsFname = fname; }
                else if (m.cat === 'rec') { recLink = link; recFname = fname; }
            } else {
                secondaryHtml += '<a class="dl-btn-secondary" href="#" onclick="safeDownload(\'' + link + '\',\'' + fname + '\',event); return false;">' +
                    '<span class="label">' + escapeHtml(m.l) + '</span>' +
                    '<span class="badge">' + m.b + '</span></a>';
            }
        });

        // Wire up download cards with safeDownload click handlers
        var dlCards = document.getElementById("dlCards");
        dlCards.innerHTML =
            '<div class="dl-card" id="dlCardAts" style="cursor:pointer"' + (atsLink ? ' onclick="safeDownload(\'' + atsLink + '\',\'' + atsFname + '\',event)"' : '') + '><div class="dl-card-icon ats"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></div><div class="dl-card-title">ATS Resume</div><div class="dl-card-desc">Optimized for automated screening systems</div><span class="dl-card-btn" id="dlBtnAts">Download PDF</span></div>' +
            '<div class="dl-card rec-card" id="dlCardRec" style="cursor:pointer"' + (recLink ? ' onclick="safeDownload(\'' + recLink + '\',\'' + recFname + '\',event)"' : '') + '><div class="dl-card-icon rec"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg></div><div class="dl-card-title">Recruiter Resume</div><div class="dl-card-desc">Enhanced for human readability</div><span class="dl-card-btn" id="dlBtnRec">Download PDF</span></div>';

        document.getElementById("dlGridSecondary").innerHTML = secondaryHtml;

        // --- Talking Points ---
        if (s.talking_points_md) {
            document.getElementById("talkingPointsCard").style.display = "block";
            document.getElementById("talkingPointsContent").innerHTML = renderMarkdown(s.talking_points_md);
        } else {
            document.getElementById("talkingPointsCard").style.display = "none";
        }

        // --- Preview tabs ---
        var previews = [
            {id: "ats", l: "ATS Resume", c: s.ats_resume_md},
            {id: "rec", l: "Recruiter Resume", c: s.recruiter_resume_md},
            {id: "changes", l: "What Changed", c: null}
        ];
        document.getElementById("tabs").innerHTML = previews.map(function(p, i) {
            return '<button class="tab ' + (i === 0 ? 'active' : '') + '" onclick="switchTab(\'' + p.id + '\',this)">' + p.l + '</button>';
        }).join("");
        document.getElementById("panels").innerHTML = previews.map(function(p, i) {
            var content = p.id === 'changes' ? buildChangesPanel(s) : renderMarkdown(p.c);
            return '<div class="tab-content ' + (i === 0 ? 'active' : '') + '" id="pnl-' + p.id + '">' + content + '</div>';
        }).join("");

        document.getElementById("resultsSection").classList.add("active");
        document.getElementById("resultsSection").scrollIntoView({behavior: "smooth"});
        } catch(renderErr) {
            console.error("Failed to render results:", renderErr);
            showError("Results loaded but failed to display. Try downloading the files directly.");
            document.getElementById("resultsSection").classList.add("active");
        }
    }

    function buildChangesPanel(s) {
        var beforeScore = Math.round(s.original_match_score || 0);
        var afterScore = Math.round(s.tailored_match_score || s.match_score || 0);
        var delta = afterScore - beforeScore;
        var deltaText = delta > 0 ? ('+' + delta + '%') : (delta + '%');

        var kwCount = (s.missing_keywords && s.missing_keywords.length) ? s.missing_keywords.length : 0;
        var bulletsCount = s.bullets_rewritten || 0;

        var jobTitle = s.job_title || 'the target role';
        var company = s.company || '';
        var roleText = company ? (escapeHtml(jobTitle) + ' at ' + escapeHtml(company)) : escapeHtml(jobTitle);

        var html = '<div class="changes-panel">';

        // Stats row
        html += '<div class="change-stats">';
        html += '<div class="change-stat"><div class="change-stat-value">' + deltaText + '</div><div class="change-stat-label">Score Improvement</div></div>';
        html += '<div class="change-stat"><div class="change-stat-value">' + kwCount + '</div><div class="change-stat-label">Keywords Targeted</div></div>';
        html += '<div class="change-stat"><div class="change-stat-value">' + bulletsCount + '</div><div class="change-stat-label">Bullets Rewritten</div></div>';
        html += '</div>';

        // Score comparison
        html += '<div class="change-section">';
        html += '<h3>Match Score Improvement</h3>';
        html += '<div class="score-comparison">';
        html += '<span class="score-before">Before: ' + beforeScore + '%</span>';
        html += '<span class="score-arrow">&rarr;</span>';
        html += '<span class="score-after">After: ' + afterScore + '%</span>';
        if (delta > 0) {
            html += '<span class="score-delta">+' + delta + ' points</span>';
        }
        html += '</div>';
        html += '</div>';

        // Keywords added
        if (s.missing_keywords && s.missing_keywords.length > 0) {
            html += '<div class="change-section">';
            html += '<h3>Keywords Targeted</h3>';
            html += '<div class="keywords-added-list">';
            s.missing_keywords.forEach(function(k) {
                html += '<span class="kw-added">' + escapeHtml(k) + '</span>';
            });
            html += '</div>';
            html += '</div>';
        }

        // Summary
        html += '<div class="change-section">';
        html += '<h3>Summary</h3>';
        var summaryText = 'Your resume was optimized for ' + roleText + '. ';
        if (bulletsCount > 0) {
            summaryText += bulletsCount + ' bullet point' + (bulletsCount !== 1 ? 's were' : ' was') + ' rewritten';
        }
        if (kwCount > 0) {
            summaryText += (bulletsCount > 0 ? ', ' : '') + kwCount + ' keyword' + (kwCount !== 1 ? 's were' : ' was') + ' targeted for the skills section';
        }
        summaryText += ', and your professional summary was tailored to highlight relevant experience.';
        var modeText = s.rewrite_mode === 'aggressive' ? 'Aggressive' : 'Conservative';
        summaryText += ' Rewrite mode: ' + modeText + '.';
        html += '<p class="change-summary">' + summaryText + '</p>';
        html += '</div>';

        html += '</div>';
        return html;
    }

    function switchTab(id, el) {
        document.querySelectorAll(".tab").forEach(function(t) { t.classList.remove("active"); });
        document.querySelectorAll(".tab-content").forEach(function(p) { p.classList.remove("active"); });
        el.classList.add("active");
        document.getElementById('pnl-' + id).classList.add("active");
    }

    function copyPreview() {
        var p = document.querySelector(".tab-content.active");
        if (!p) return;
        navigator.clipboard.writeText(p.textContent).then(function() {
            var b = document.querySelector(".copy-btn");
            b.textContent = "Copied!";
            setTimeout(function() { b.textContent = "Copy"; }, 2000);
        });
    }

    function toggleAdditional() {
        var btn = document.getElementById("additionalToggle");
        var files = document.getElementById("additionalFiles");
        btn.classList.toggle("open");
        files.classList.toggle("open");
    }

    function resetForm() {
        fileInput.value = "";
        jdTA.value = "";
        uploadZone.classList.remove("has-file");
        fileNameEl.style.display = "none";
        document.getElementById("resultsSection").classList.remove("active");
        document.getElementById("progressSection").classList.remove("active");
        document.getElementById("formSection").style.display = "";
        document.getElementById("charCount").textContent = "0";
        document.getElementById("wordCount").textContent = "0";
        jdTA.classList.remove('input-error');
        document.getElementById('jdError').classList.remove('visible');
        dismissError();
        stopTipRotation();
        stopElapsedTimer();
        targetProgress = 0;
        currentProgress = 0;

        // Reset score ring
        var ring = document.getElementById("scoreRing");
        if (ring) {
            ring.style.strokeDashoffset = 376.99;
        }

        // Reset download cards to divs (in case they became <a> tags)
        var dlCards = document.getElementById("dlCards");
        if (dlCards) {
            dlCards.innerHTML =
                '<div class="dl-card" id="dlCardAts">' +
                    '<div class="dl-card-icon ats"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></div>' +
                    '<div class="dl-card-title">ATS Resume</div>' +
                    '<div class="dl-card-desc">Optimized for automated screening systems</div>' +
                    '<span class="dl-card-btn" id="dlBtnAts">Download PDF</span>' +
                '</div>' +
                '<div class="dl-card rec-card" id="dlCardRec">' +
                    '<div class="dl-card-icon rec"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg></div>' +
                    '<div class="dl-card-title">Recruiter Resume</div>' +
                    '<div class="dl-card-desc">Enhanced for human readability</div>' +
                    '<span class="dl-card-btn" id="dlBtnRec">Download PDF</span>' +
                '</div>';
        }

        // Close additional files
        document.getElementById("additionalToggle").classList.remove("open");
        document.getElementById("additionalFiles").classList.remove("open");

        var btn = document.getElementById("btnRun");
        btn.disabled = false;
        btn.textContent = "Tailor My Resume";
        document.querySelector(".site-header").scrollIntoView({behavior: "smooth"});
    }
    </script>
</body>
</html>
